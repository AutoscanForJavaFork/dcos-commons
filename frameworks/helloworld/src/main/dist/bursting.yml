name: {{FRAMEWORK_NAME}}
scheduler:
  principal: {{FRAMEWORK_PRINCIPAL}}
  user: {{FRAMEWORK_USER}}
pods:
  hello:
    count: {{HELLO_COUNT}}
    tasks:
      unlimited:
        goal: RUNNING
        cmd: |
            CGROUP_MEM_NAME=$(cat /proc/self/cgroup | egrep "[:,]memory[,:]" | cut -f 3 -d :)
            CGROUP_CPU_NAME=$(cat /proc/self/cgroup | egrep "[:,]cpu[,:]" | cut -f 3 -d :)

            CGROUP_CPU_QUOTA=$(/sys/fs/cgroup/cpu${CGROUP_CPU_NAME}/cpu.cfs_quota_us)

            if [ "$CGROUP_CPU_QUOTA" != "-1" ]; then
              echo "CPU is not unlimited!"
              exit 1
            fi

            SYS_MEM_LIMIT=$(cat /sys/fs/cgroup/memory/memory.limit_in_bytes)
            CGROUP_MEM_LIMIT_IN_BYTES=$(/sys/fs/cgroup/memory${CGROUP_MEM_NAME}/memory.limit_in_bytes$)

            if [ "$SYS_MEM_LIMIT" != "$CGROUP_MEM_LIMIT_IN_BYTES" ]; then
              # when memory is set to unlimited in a cgroup, usually its value matches the one in /sys/fs/cgroup/memory; the actual value is a REALLY BIG NUMBER, 0x7ffffffffffff000
              echo "Memory does not appear to be unlimited!"
              exit 1
            fi

            echo hello >> output && sleep $SLEEP_DURATION

        cpus: {{HELLO_CPUS}}
        memory: {{HELLO_MEM}}
        resource-limits:
          cpus: "unlimited"
          memory: "unlimited"
        env:
          SLEEP_DURATION: {{SLEEP_DURATION}}
            
          
