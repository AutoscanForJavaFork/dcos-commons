<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>SDK Developer Guide</title>
<link rel="stylesheet" type="text/css" media="all" href="/dcos-commons/style/layout.css" />
<link rel="shortcut icon" type="image/png" href="https://mesosphere.com/favicon.ico"/>
<!-- The Dropdown library is written by Stephen Morley, licensed CC0 1.0 Universal (Public Domain Dedication)-->
<link rel="stylesheet" type="text/css" media="all" href="/dcos-commons/style/Dropdown.css" />
<script src="/dcos-commons/style/Dropdown.js"></script>
<style type="text/css">
/* set the background color of menu items */
.dropdown, .dropdown ul { background: #555555; clear: both; }
/* set the background color of active items */
.dropdown li:hover > a, .dropdown li:hover > span, .dropdown li.dropdownOpen > a, .dropdown li.dropdownOpen > span { background: #af87e0; }
/* pad items, set their text color, and fade their background color */
.dropdown a, .dropdown span { padding: 0.25em 0.5em; color: white; transition: background 0.2s; }
/* show '+' on expandable items */
.dropdown span:after { content: " +"; }

/* toc style: remove extra margin between elements */
.section-nav ul { margin: 0; }
</style>
</head>

<body>
<div id="wrapper">

<a href="/dcos-commons/">
<img style="float: left; margin-bottom: 2em" src="https://mesosphere.com/wp-content/themes/mesosphere/library/images/assets/dcos-sdk-logo.png" width="250" alt="DC/OS Software Development Kit" />
</a>
<img style="float: right" src="https://img.shields.io/badge/Status-Alpha-BF97F0.svg?style=flat-square" alt="Status: Alpha" />



<ul class="dropdown" style="clear: both">
  <li>
    <a href="/dcos-commons/">Home</a>
  </li>
  <li>
    <span>Documentation</span>
    <ul>
      
      
      
      <li><a href="/dcos-commons/developer-guide/">SDK Developer Guide</a></li>
      
      <li><a href="/dcos-commons/plans/">Plans and Deployment</a></li>
      
      <li><a href="/dcos-commons/multi-service/">Building Multi-Service Schedulers</a></li>
      
      <li><a href="/dcos-commons/yaml-reference/">YAML Reference</a></li>
      
      <li><a href="/dcos-commons/faq/">Frequently Asked Questions</a></li>
      
      <li><a href="/dcos-commons/glossary/">Glossary</a></li>
      
      <li><a href="/dcos-commons/reference/api">Javadoc Reference</a></li>
      <li><a href="/dcos-commons/reference/swagger-api">REST APIs</a></li>
    </ul>
  </li>
  <li>
    <span>Tutorials</span>
    <ul>
      
      
      
      <li><a href="/dcos-commons/tutorials/secrets-tutorial/">Secrets Tutorial</a></li>
      
    </ul>
  </li>
  
  <li><a href="https://github.com/mesosphere/dcos-commons/blob/master/CONTRIBUTING.md">Contributing</a></li>
  <li><a href="http://chat.dcos.io" target="_blank">Slack</a></li>
</ul>
<h1>SDK Developer Guide</h1>
<div id="content">

<ul class="section-nav">
<li class="toc-entry toc-h1"><a href="#dcos-component-overview">DC/OS Component Overview</a>
<ul>
<li class="toc-entry toc-h2"><a href="#apache-mesos">Apache Mesos</a></li>
<li class="toc-entry toc-h2"><a href="#marathon">Marathon</a></li>
<li class="toc-entry toc-h2"><a href="#universe">Universe</a></li>
<li class="toc-entry toc-h2"><a href="#zookeeper">ZooKeeper</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#introduction-to-dcos-service-definitions">Introduction to DC/OS Service Definitions</a>
<ul>
<li class="toc-entry toc-h2"><a href="#servicespec">ServiceSpec</a>
<ul>
<li class="toc-entry toc-h3"><a href="#annotated-example-of-a-servicespec">Annotated Example of a ServiceSpec</a></li>
<li class="toc-entry toc-h3"><a href="#summary">Summary</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#plans">Plans</a>
<ul>
<li class="toc-entry toc-h3"><a href="#default-deployment-plan">Default Deployment Plan</a></li>
<li class="toc-entry toc-h3"><a href="#custom-deployment-plan">Custom Deployment Plan</a>
<ul>
<li class="toc-entry toc-h4"><a href="#removal-from-deployment-plans">Removal From Deployment Plans</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#custom-update-plans">Custom Update Plans</a></li>
<li class="toc-entry toc-h3"><a href="#custom-auxiliary-plans">Custom Auxiliary Plans</a></li>
<li class="toc-entry toc-h3"><a href="#programmatic-plan-modification">Programmatic Plan Modification</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#packaging">Packaging</a>
<ul>
<li class="toc-entry toc-h3"><a href="#universe-package-files-at-a-glance">Universe Package Files At-a-Glance</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#basic-operations">Basic Operations</a>
<ul>
<li class="toc-entry toc-h2"><a href="#defining-a-target-configuration">Defining a Target Configuration</a></li>
<li class="toc-entry toc-h2"><a href="#plan-execution">Plan Execution</a>
<ul>
<li class="toc-entry toc-h3"><a href="#plan-acceptance-or-rejection">Plan Acceptance or Rejection</a></li>
<li class="toc-entry toc-h3"><a href="#executing-a-plan">Executing a Plan</a></li>
<li class="toc-entry toc-h3"><a href="#install">Install</a></li>
<li class="toc-entry toc-h3"><a href="#update">Update</a>
<ul>
<li class="toc-entry toc-h4"><a href="#vertical-scale-example">Vertical Scale Example</a></li>
<li class="toc-entry toc-h4"><a href="#horizontal-scale-example">Horizontal Scale Example</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#rollback">Rollback</a></li>
<li class="toc-entry toc-h3"><a href="#software-upgrade">Software Upgrade</a></li>
<li class="toc-entry toc-h3"><a href="#api">API</a>
<ul>
<li class="toc-entry toc-h4"><a href="#view">View</a></li>
<li class="toc-entry toc-h4"><a href="#interrupt">Interrupt</a></li>
<li class="toc-entry toc-h4"><a href="#continue">Continue</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#service-discovery">Service Discovery</a>
<ul>
<li class="toc-entry toc-h2"><a href="#mesos-dns">Mesos-DNS</a></li>
<li class="toc-entry toc-h2"><a href="#vip">VIP</a></li>
<li class="toc-entry toc-h2"><a href="#virtual-networks">Virtual networks</a></li>
<li class="toc-entry toc-h2"><a href="#label-based-discovery">Label-Based Discovery</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#metrics">Metrics</a>
<ul>
<li class="toc-entry toc-h2"><a href="#default">Default</a>
<ul>
<li class="toc-entry toc-h5"><a href="#offers">Offers</a></li>
<li class="toc-entry toc-h5"><a href="#operations">Operations</a></li>
<li class="toc-entry toc-h5"><a href="#status">Status</a></li>
<li class="toc-entry toc-h5"><a href="#reporting">Reporting</a>
<ul>
<li class="toc-entry toc-h6"><a href="#json">JSON</a></li>
<li class="toc-entry toc-h6"><a href="#prometheus">Prometheus</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#custom-metrics">Custom Metrics</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#secrets">Secrets</a>
<ul>
<li class="toc-entry toc-h3"><a href="#authorization-for-secrets">Authorization for Secrets</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#regions-and-zones">Regions and Zones</a>
<ul>
<li class="toc-entry toc-h2"><a href="#regions-beta">Regions (beta)</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#tls">TLS</a>
<ul>
<li class="toc-entry toc-h2"><a href="#provisioning">Provisioning</a>
<ul>
<li class="toc-entry toc-h3"><a href="#lifetime-of-secrets-containing-the-tls-artifacts">Lifetime of secrets containing the TLS artifacts</a></li>
<li class="toc-entry toc-h3"><a href="#task-artifacts-access">Task artifacts access</a></li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#private-key-and-certificate-details">Private key and certificate details</a>
<ul>
<li class="toc-entry toc-h3"><a href="#private-key">Private key</a></li>
<li class="toc-entry toc-h3"><a href="#x509-certificate">X.509 certificate</a></li>
<li class="toc-entry toc-h3"><a href="#artifacts-format">Artifacts format</a>
<ul>
<li class="toc-entry toc-h4"><a href="#pem">PEM</a></li>
<li class="toc-entry toc-h4"><a href="#java-keystore">Java Keystore</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-entry toc-h2"><a href="#installation-requirements">Installation requirements</a></li>
<li class="toc-entry toc-h2"><a href="#externalizing-transport-encryption-and-security">Externalizing Transport Encryption and Security</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#testing">Testing</a>
<ul>
<li class="toc-entry toc-h2"><a href="#unit-tests">Unit tests</a></li>
<li class="toc-entry toc-h2"><a href="#integration-tests">Integration tests</a></li>
</ul>
</li>
<li class="toc-entry toc-h1"><a href="#advanced-dcos-service-definition">Advanced DC/OS Service Definition</a>
<ul>
<li class="toc-entry toc-h2"><a href="#servicespec-yaml">ServiceSpec (YAML)</a>
<ul>
<li class="toc-entry toc-h3"><a href="#pods">Pods</a></li>
<li class="toc-entry toc-h3"><a href="#non-essential-tasks">Non-essential tasks</a></li>
<li class="toc-entry toc-h3"><a href="#containers">Containers</a></li>
<li class="toc-entry toc-h3"><a href="#placement-rules">Placement Rules</a></li>
<li class="toc-entry toc-h3"><a href="#resource-sets">Resource Sets</a></li>
<li class="toc-entry toc-h3"><a href="#sidecar-plans">Sidecar Plans</a></li>
<li class="toc-entry toc-h3"><a href="#uris">URIs</a></li>
<li class="toc-entry toc-h3"><a href="#configuration-templates">Configuration Templates</a></li>
<li class="toc-entry toc-h3"><a href="#task-environment">Task Environment</a>
<ul>
<li class="toc-entry toc-h4"><a href="#included-values">Included Values</a></li>
<li class="toc-entry toc-h4"><a href="#specifying-values">Specifying Values</a></li>
</ul>
</li>
<li class="toc-entry toc-h3"><a href="#task-bootstrap">Task Bootstrap</a></li>
<li class="toc-entry toc-h3"><a href="#health-checks">Health Checks</a></li>
<li class="toc-entry toc-h3"><a href="#readiness-checks">Readiness Checks</a></li>
<li class="toc-entry toc-h3"><a href="#volumes">Volumes</a></li>
<li class="toc-entry toc-h3"><a href="#proxy-fallback">Proxy Fallback</a></li>
</ul>
</li>
</ul>
</li>
</ul><!--  disable mustache templating in this file: retain templated examples as-is -->

<p>This developer guide explains how to create a stateful DC/OS service using the DC/OS SDK. The DC/OS SDK is a collection of tools, libraries, and documentation that facilitates the creation of DC/OS services. For information about running DC/OS SDK services in an operational context, look at the <a href="../operations-guide/">Operations Guide</a>.</p>

<h1 id="dcos-component-overview">
<a id="dcos-component-overview" class="anchor" href="#dcos-component-overview" aria-hidden="true"><span class="octicon octicon-link"></span></a>DC/OS Component Overview</h1>

<p>The four major components are Apache Mesos, Marathon, Universe, and Apache ZooKeeper. These components have different responsibilities and must cooperate. To develop a service, you should have a high level understanding of these components and their responsibilities.</p>

<h2 id="apache-mesos">
<a id="apache-mesos" class="anchor" href="#apache-mesos" aria-hidden="true"><span class="octicon octicon-link"></span></a>Apache Mesos</h2>

<p>DC/OS is modeled on an operating system with Mesos as its kernel. Mesos provides an abstraction to enable consumption of the resources a datacenter provides.  In a typical case, these resources are CPU, memory, disk space, and ports. Tasks are launched in the datacenter and consume particular subsets of resources. The programs that can receive resource offers and launch tasks that consume are called <strong>frameworks</strong>. The component of a framework that receives offers and launches tasks is called the <strong>scheduler</strong>.</p>

<p>Mesos determines which frameworks should be offered resources at any given time. It sends update events regarding the status of those tasks. These events include <em>staging, running, failed</em>,* *etc.  To learn more about Mesos, consult “<a href="https://mesos.apache.org/">Apache Mesos</a>”.</p>

<h2 id="marathon">
<a id="marathon" class="anchor" href="#marathon" aria-hidden="true"><span class="octicon octicon-link"></span></a>Marathon</h2>

<p>The scheduler is the  entity that can launch tasks on DC/OS.  The role of Marathon is to launch Mesos tasks and to restart them if they crash.  In the context of the SDK, the tasks that Marathon launches are schedulers.  These schedulers in turn launch the tasks necessary for the operation of a DC/OS service. Therefore, if a scheduler crashes, it is Marathon’s responsibility to restart the scheduler.</p>

<p>If we consider Mesos to be DC/OS’ kernel, then Marathon is its init system. It launches and keeps up the software that should be running on the operating system.</p>

<p>Marathon is itself a Mesos framework. Some of the tasks it launches are the schedulers written with the SDK described here. Application and pod definitions are declarative JSON representations of a task or tasks that Marathon should run. To learn more, consult the <a href="https://mesosphere.github.io/marathon/">Marathon documentation</a>.</p>

<h2 id="universe">
<a id="universe" class="anchor" href="#universe" aria-hidden="true"><span class="octicon octicon-link"></span></a>Universe</h2>

<p>A package specification provides a uniform way to define Marathon applications.  Those packages are stored in the Universe so end-users can easily install these DC/OS services in their datacenters..</p>

<p>Every DC/OS service must provide a package definition in the format expected by the Universe. <a href="https://github.com/mesosphere/universe">Learn more about creating Universe packages</a>.</p>

<h2 id="zookeeper">
<a id="zookeeper" class="anchor" href="#zookeeper" aria-hidden="true"><span class="octicon octicon-link"></span></a>ZooKeeper</h2>

<p>Several DC/OS components, including Mesos and Marathon, require a persistent metadata store. ZooKeeper fulfills this role for those components as well as for services written using the SDK. As noted previously, any service written using the SDK is a Mesos scheduler. In order to accurately communicate with Mesos, every scheduler must keep a record of the state of its tasks. ZooKeeper provides persistent storage for this information.</p>

<p>Although all SDK services written today store metadata in ZooKeeper, this is an implementation detail. The <a href="https://github.com/mesosphere/dcos-commons/blob/master/sdk/scheduler/src/main/java/com/mesosphere/sdk/state/ConfigStore.java">ConfigStore</a> and <a href="https://github.com/mesosphere/dcos-commons/blob/master/sdk/scheduler/src/main/java/com/mesosphere/sdk/state/StateStore.java">StateStore</a> interfaces are generic and unopinionated about the backing persistent metadata store.</p>

<p>They store the desired configuration of a service and all relevant information regarding Mesos tasks, respectively, but the precise format or location of the underlying data may be customized.  For example, the data may be stored in ZooKeeper, but in a different format, or the data may be stored in a different persistent storage like etcd.  The defaults should be reasonable for most developers, however. Support for optional customization via drop-in replacement is a common pattern throughout the SDK.</p>

<h1 id="introduction-to-dcos-service-definitions">
<a id="introduction-to-dcos-service-definitions" class="anchor" href="#introduction-to-dcos-service-definitions" aria-hidden="true"><span class="octicon octicon-link"></span></a>Introduction to DC/OS Service Definitions</h1>

<p>At the highest level of abstraction, a DC/OS service breaks down into <em>which</em> tasks to launch and <em>how</em> to launch them. The <a href="https://github.com/mesosphere/dcos-commons/blob/master/sdk/scheduler/src/main/java/com/mesosphere/sdk/specification/ServiceSpec.java">ServiceSpec</a> defines what a service is and <a href="#plans">Plan</a>[s] define how to control it in deployment, update, and failure scenarios. The <a href="https://github.com/mesosphere/dcos-commons/blob/master/sdk/scheduler/src/main/java/com/mesosphere/sdk/specification/ServiceSpec.java">ServiceSpec</a> and <a href="#plans">Plan</a>[s] are <a href="#packaging">packaged</a> so that the service can be deployed on a DC/OS cluster from Universe.</p>

<p><a name="service-spec"></a></p>
<h2 id="servicespec">
<a id="servicespec" class="anchor" href="#servicespec" aria-hidden="true"><span class="octicon octicon-link"></span></a>ServiceSpec</h2>

<p>There are two ways to generate a valid <code class="highlighter-rouge">ServiceSpec</code>: creating a YAML file or writing Java code. Both produce a valid implementation of the Java <code class="highlighter-rouge">ServiceSpec</code> interface.  A <code class="highlighter-rouge">ServiceSpec</code> may be used to launch one or more instances of the same service within a DC/OS cluster.</p>

<p>For example, one could write a <code class="highlighter-rouge">ServiceSpec</code> that describes a DC/OS service that deploys a Kafka cluster. One could then install one or more instances of a Kafka cluster in a DC/OS cluster. A <code class="highlighter-rouge">ServiceSpec</code> is in this sense similar to a class definition, which may be used to create many objects that are instances of the class.</p>

<h3 id="annotated-example-of-a-servicespec">
<a id="annotated-example-of-a-servicespec" class="anchor" href="#annotated-example-of-a-servicespec" aria-hidden="true"><span class="octicon octicon-link"></span></a>Annotated Example of a <code class="highlighter-rouge">ServiceSpec</code>
</h3>

<p>This simple YAML definition of a DC/OS service that prints “hello world” to stdout in a container sandbox every 1000 seconds.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">scheduler</span><span class="pi">:</span>
  <span class="na">principal</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world-principal"</span>
  <span class="na">user</span><span class="pi">:</span> <span class="pi">{{</span><span class="nv">SERVICE_USER</span><span class="pi">}}</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello-world-pod</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">hello-world-task</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">world</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">0.1</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">512</span>
</code></pre></div></div>

<ul>
  <li>
    <p><strong>name</strong>:  This is the name of an instance of a DC/OS service. No two instances of any service may have the same name in the same cluster.</p>
  </li>
  <li>
    <p><strong>scheduler</strong>: The Scheduler manages the service and keeps it running. This section contains settings which apply to the Scheduler. The <code class="highlighter-rouge">scheduler</code> section may be omitted to use reasonable defaults for all of these settings.</p>

    <ul>
      <li>
        <p><strong>principal</strong>: This is the DC/OS service account used when registering the framework. In secure Enterprise clusters, this account must have the necessary permission to perform the actions of a scheduler. This setting may be omitted in which case it defaults to <code class="highlighter-rouge">&lt;svcname&gt;-principal</code>.</p>
      </li>
      <li>
        <p><strong>user</strong> This is the account used when running the processes on the host.  The recommended default is <code class="highlighter-rouge">nobody</code>.</p>
      </li>
    </ul>
  </li>
  <li>
    <p><strong>Pods</strong>: A pod is simply a set of tasks.</p>

    <ul>
      <li>
        <p><strong>hello-world-pod</strong>: This is the name of a type of a pod. You can choose any name for a pod type  In this example, we have one kind of pod defined and its name is <code class="highlighter-rouge">hello-world-pod</code>.</p>

        <ul>
          <li>
            <p><strong>count</strong>: The number of instances of the pod.</p>
          </li>
          <li>
            <p><strong>tasks</strong>: The list of tasks in the pod.</p>
          </li>
          <li>
            <p><strong>hello-world-task</strong>: In this example, the single pod definition is composed of a single task. The name of this task is “hello-world-task”.</p>

            <ul>
              <li>
                <p><strong>goal</strong>: Every task must have a goal state. There are three possible goal states: <code class="highlighter-rouge">RUNNING</code>, <code class="highlighter-rouge">FINISH</code> and <code class="highlighter-rouge">ONCE</code>. <code class="highlighter-rouge">RUNNING</code> indicates that a task should always be running, so if it exits, it should be restarted. <code class="highlighter-rouge">FINISH</code> indicates that if a task finishes successfully it does not need to be restarted unless its configuration is updated. <code class="highlighter-rouge">ONCE</code> indicates that if a task finishes successfully it does not need to be restarted for the duration of the pod’s lifetime.</p>
              </li>
              <li>
                <p><strong>cmd</strong>: The command to run to start a task. Here, the task will print “hello world” to stdout and sleep for 1000 seconds. Because its goal state is <code class="highlighter-rouge">RUNNING</code>, it will be started again upon exit.</p>
              </li>
              <li>
                <p><strong>cpus</strong>: This entry defines how many CPUs will be allocated to the task’s container.  For discussion of how resources are isolated and allocate <a href="https://mesos.apache.org/documentation/latest/containerizers/">see the Mesos documentation here</a>.</p>
              </li>
              <li>
                <p><strong>memory</strong>: This entry defines how much memory will be allocated to the task’s container.</p>
              </li>
            </ul>
          </li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<p>For a full listing of available fields and what they mean, see the <a href="../yaml-reference/">YAML Reference</a>.</p>

<h3 id="summary">
<a id="summary" class="anchor" href="#summary" aria-hidden="true"><span class="octicon octicon-link"></span></a>Summary</h3>

<p>A set of pods defines <em>what</em> your service is. Pods are composed of task definitions.</p>

<p>In the example, we have only defined types of pods and tasks. When the service is deployed and instantiated into instances of these types, we get a Mesos task like the following:</p>

<table>
  <tr>
    <td>Task Name</td>
    <td>Task ID</td>
    <td>Task Status</td>
  </tr>
  <tr>
    <td>hello-world-pod-0-hello-world-task</td>
    <td>hello-world-pod-0-hello-world-task__c111c97e-7236-4fea-b06f-0216c93b853b</td>
    <td>TASK_RUNNING</td>
  </tr>
</table>

<p>Since a single pod instance was requested via the <em>count</em> element, only a single task was launched. Its index (0) was injected into the task name and ID. If we had defined a count higher than one, more tasks with incremental indices would have been launched.</p>

<h2 id="plans">
<a id="plans" class="anchor" href="#plans" aria-hidden="true"><span class="octicon octicon-link"></span></a>Plans</h2>

<p>In the simple example above, it is obvious <em>how</em> to deploy this service.  It consists of a launching a single task. For more complex services with multiple pods, the SDK allows the definition of <em>plans</em> to orchestrate the deployment of tasks. You can learn more about the full capabilities of plans <a href="#plan-execution">here</a> and <a href="#custom-plans-java">here</a>.</p>

<p>For more in-depth information about how Plans work internally, see the <a href="../plans/">Plans and Deployment</a> documentation.</p>

<h3 id="default-deployment-plan">
<a id="default-deployment-plan" class="anchor" href="#default-deployment-plan" aria-hidden="true"><span class="octicon octicon-link"></span></a>Default Deployment Plan</h3>

<p>The example below defines a service with two types of pods, each of which deploys two instances.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello-pod</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">2</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">hello-task</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">0.1</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">512</span>
  <span class="na">world-pod</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">2</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">world-task</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">world</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">0.1</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">512</span>
</code></pre></div></div>

<p>There are a number of possible deployment strategies: In parallel or serially, and with or without one pod type waiting for the other’s successful deployment before deploying.</p>

<p>By default, the SDK will deploy all instances of pods serially.  In the example above, the default deployment order would be:</p>

<ol>
  <li><code class="highlighter-rouge">hello-pod-0-hello-task</code></li>
  <li><code class="highlighter-rouge">hello-pod-1-hello-task</code></li>
  <li><code class="highlighter-rouge">world-pod-0-world-task</code></li>
  <li><code class="highlighter-rouge">world-pod-1-world-task</code></li>
</ol>

<p>Each pod’s task must reach its goal of <code class="highlighter-rouge">RUNNING</code> before the next pod is launched. This is the simplest and safest possible approach as a default deployment strategy.</p>

<p>However, this default deployment strategy does not provide the flexibility you need to write rich services. The SDK therefore also allows you to define <em>plans</em> that orchestrate task deployment.</p>

<p>In this section we focus on using plans to define the initial deployment of a service. However, you can also use plans to orchestrate configuration updates, software upgrades, and recovery from complex, service-specific failure scenarios.</p>

<p>As an example, let’s consider the scenario where we wish to deploy the hello-pods in parallel, wait for them to reach a <code class="highlighter-rouge">RUNNING</code> state and then deploy the world-pods serially.  We could amend our YAML file to look like the following:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello-pod</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">2</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">hello-task</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">0.1</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">512</span>
  <span class="na">world-pod</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">2</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">hello-task</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">world</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">0.1</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">512</span>
<span class="na">plans</span><span class="pi">:</span>
  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
    <span class="na">phases</span><span class="pi">:</span>
      <span class="na">hello-phase</span><span class="pi">:</span>
        <span class="na">strategy</span><span class="pi">:</span> <span class="s">parallel</span>
        <span class="na">pod</span><span class="pi">:</span> <span class="s">hello-pod</span>
      <span class="na">world-phase</span><span class="pi">:</span>
        <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
        <span class="na">pod</span><span class="pi">:</span> <span class="s">world-pod</span>
</code></pre></div></div>

<p>A plan is a simple three layer hierarchical structure.  A plan is composed of phases, which in turn are composed of steps.  Each layer may define a strategy for how to deploy its constituent elements. The strategy at the highest layer defines how to deploy phases. Each phase’s strategy defines how to deploy steps. The default strategy if none is specified is serial.</p>

<p><img src="/dcos-commons/img/dev-guide-plans-vs-services.png" alt="plans vs services"></p>

<p>A phase encapsulates a pod type and a step encapsulates an instance of a pod.  So in this case we have two phases: hello-phase and world-phase.  They are clearly associated with their particular pod definitions from the ServiceSpec. In the example above, we do not need to specifically define steps to accomplish our deployment strategy goal, so they are omitted.</p>

<p>The hello-phase of the example has two elements: a strategy and a pod.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">plans</span><span class="pi">:</span>
  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
    <span class="na">phases</span><span class="pi">:</span>
      <span class="na">hello-phase</span><span class="pi">:</span>
        <span class="na">strategy</span><span class="pi">:</span> <span class="s">parallel</span>
        <span class="na">pod</span><span class="pi">:</span> <span class="s">hello-pod</span>
      <span class="na">world-phase</span><span class="pi">:</span>
        <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
        <span class="na">pod</span><span class="pi">:</span> <span class="s">world-pod</span>
</code></pre></div></div>

<p>The pod parameter references the pod definition earlier in the <code class="highlighter-rouge">ServiceSpec</code>. The strategy declares how to deploy the instances of the pod. Here, they will be deployed in parallel. The world-phase section is identical, except that its elements will be deployed serially.</p>

<p>The strategy associated with the deployment plan as a whole is serial, so the phases should be deployed one at a time. This dependency graph illustrates the deployment.</p>

<p><img src="/dcos-commons/img/dev-guide-deployment-steps.png" alt="deployment steps"></p>

<p>The dependency of the <code class="highlighter-rouge">world-pod</code> phase on the <code class="highlighter-rouge">hello-pod</code> phase serializes those two phases as described at the top level strategy element. Since both <code class="highlighter-rouge">hello</code> steps depend on a the<code class="highlighter-rouge"> hello-pod</code> phase, and not each other, they are executed in parallel. The second <code class="highlighter-rouge">world-pod</code> instance depends on the first, so they are launched serially.</p>

<h3 id="custom-deployment-plan">
<a id="custom-deployment-plan" class="anchor" href="#custom-deployment-plan" aria-hidden="true"><span class="octicon octicon-link"></span></a>Custom Deployment Plan</h3>

<p>More powerful custom plans can also be written. Consider the case in which a pod requires an initialization step to be run before the main task of a pod is run. One could define the tasks for such a pod as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">2</span>
    <span class="na">resource-sets</span><span class="pi">:</span>
      <span class="na">hello-resources</span><span class="pi">:</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">1.0</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
        <span class="na">volume</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s">hello-data</span>
          <span class="na">size</span><span class="pi">:</span> <span class="s">5000</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">ROOT</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">init</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">ONCE</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./init"</span>
        <span class="na">resource-set</span><span class="pi">:</span> <span class="s">hello-resources</span>
      <span class="na">main</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./main"</span>
        <span class="na">resource-set</span><span class="pi">:</span> <span class="s">hello-resources</span>
</code></pre></div></div>

<p>By default, the plan generated from such a service definition would only deploy the <code class="highlighter-rouge">main</code> task because when the <code class="highlighter-rouge">init</code> task should be run is undefined.  In order to run the init task and then the main task for each instance of the <code class="highlighter-rouge">hello</code> pod one could write a plan as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">init</span><span class="pi">:</span>
        <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
      <span class="na">main</span><span class="pi">:</span>
        <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
<span class="na">plans</span><span class="pi">:</span>
  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
    <span class="na">phases</span><span class="pi">:</span>
      <span class="na">hello-phase</span><span class="pi">:</span>
        <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
        <span class="na">pod</span><span class="pi">:</span> <span class="s">hello</span>
        <span class="na">steps</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">default</span><span class="pi">:</span> <span class="pi">[[</span><span class="nv">init</span><span class="pi">],</span> <span class="pi">[</span><span class="nv">main</span><span class="pi">]]</span>
</code></pre></div></div>

<p>This plan indicates that by default, every instance of the hello pod should have two steps generated: one representing the <code class="highlighter-rouge">init</code> task and another representing the <code class="highlighter-rouge">main</code> task. The ServiceSpec indicates that two <code class="highlighter-rouge">hello</code> pods should be launched so the following tasks would be launched by steps serially:</p>

<ol>
  <li><code class="highlighter-rouge">hello-0-init</code></li>
  <li><code class="highlighter-rouge">hello-0-main</code></li>
  <li><code class="highlighter-rouge">hello-1-init</code></li>
  <li><code class="highlighter-rouge">hello-1-main</code></li>
</ol>

<p>Consider the case where the init task should only occur once for the first pod, and all subsequent pods should just launch their <code class="highlighter-rouge">main</code> task. Such a plan could be written as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">init</span><span class="pi">:</span>
        <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
      <span class="na">main</span><span class="pi">:</span>
        <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
<span class="na">plans</span><span class="pi">:</span>
  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
    <span class="na">phases</span><span class="pi">:</span>
      <span class="na">hello-phase</span><span class="pi">:</span>
        <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
        <span class="na">pod</span><span class="pi">:</span> <span class="s">hello</span>
        <span class="na">steps</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">0</span><span class="pi">:</span> <span class="pi">[[</span><span class="nv">init</span><span class="pi">],</span> <span class="pi">[</span><span class="nv">main</span><span class="pi">]]</span>
          <span class="pi">-</span> <span class="na">default</span><span class="pi">:</span> <span class="pi">[[</span><span class="nv">main</span><span class="pi">]]</span>
</code></pre></div></div>

<p>This plan would result in steps generating the following tasks:</p>

<ol>
  <li><code class="highlighter-rouge">hello-0-init</code></li>
  <li><code class="highlighter-rouge">hello-0-main</code></li>
  <li><code class="highlighter-rouge">hello-1-main</code></li>
</ol>

<h4 id="removal-from-deployment-plans">
<a id="removal-from-deployment-plans" class="anchor" href="#removal-from-deployment-plans" aria-hidden="true"><span class="octicon octicon-link"></span></a>Removal From Deployment Plans</h4>

<p>If your custom deployment plan is later updated to no longer reference pods or tasks which are still listed in your pod spec, the affected tasks will be killed but their resources will not be returned to the cluster. <strong>Note:</strong> If you instead wish to kill tasks <em>and</em> release their resources back to the cluster, you may do so through the <a href="#pods">pod decommission</a> process.</p>

<p>For example, updating a <code class="highlighter-rouge">ServiceSpec</code> from:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
  <span class="na">world</span><span class="pi">:</span>
    <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
<span class="na">plans</span><span class="pi">:</span>
  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
    <span class="na">phases</span><span class="pi">:</span>
      <span class="na">hello-phase</span><span class="pi">:</span>
        <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
        <span class="na">pod</span><span class="pi">:</span> <span class="s">hello</span>
      <span class="na">world-phase</span><span class="pi">:</span>
        <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
        <span class="na">pod</span><span class="pi">:</span> <span class="s">world</span>
</code></pre></div></div>

<p>to:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
  <span class="na">world</span><span class="pi">:</span>
    <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
<span class="na">plans</span><span class="pi">:</span>
  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
    <span class="na">phases</span><span class="pi">:</span>
      <span class="na">hello-phase</span><span class="pi">:</span>
        <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
        <span class="na">pod</span><span class="pi">:</span> <span class="s">hello</span>
</code></pre></div></div>

<p>would result in all tasks in the <code class="highlighter-rouge">world-&lt;index&gt;</code> pod instances being killed, but their resources would not be returned to the cluster. To unreserve resources associated with the <code class="highlighter-rouge">world</code> pod instances, a <a href="#pods">decommission operation</a> would need to be performed.</p>

<p>This behavior can also function at per-task granularity when custom <code class="highlighter-rouge">steps</code> are being specified. For example, updating a <code class="highlighter-rouge">ServiceSpec</code> from:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">monitor</span><span class="pi">:</span>
        <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
      <span class="na">main</span><span class="pi">:</span>
        <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
<span class="na">plans</span><span class="pi">:</span>
  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
    <span class="na">phases</span><span class="pi">:</span>
      <span class="na">hello-phase</span><span class="pi">:</span>
        <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
        <span class="na">pod</span><span class="pi">:</span> <span class="s">hello</span>
        <span class="na">steps</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">default</span><span class="pi">:</span> <span class="pi">[[</span><span class="nv">monitor</span><span class="pi">,</span> <span class="nv">main</span><span class="pi">]]</span>
</code></pre></div></div>

<p>to:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">monitor</span><span class="pi">:</span>
        <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
      <span class="na">main</span><span class="pi">:</span>
        <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
<span class="na">plans</span><span class="pi">:</span>
  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
    <span class="na">phases</span><span class="pi">:</span>
      <span class="na">hello-phase</span><span class="pi">:</span>
        <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
        <span class="na">pod</span><span class="pi">:</span> <span class="s">hello</span>
        <span class="na">steps</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">default</span><span class="pi">:</span> <span class="pi">[[</span><span class="nv">main</span><span class="pi">]]</span>
</code></pre></div></div>

<p>would result in all <code class="highlighter-rouge">hello-&lt;index&gt;-monitor</code> tasks being killed without their resources being returned to the cluster, while the <code class="highlighter-rouge">hello-&lt;index&gt;-main</code> tasks would continue running. To unreserve resources associated with the <code class="highlighter-rouge">monitor</code> tasks, a <a href="#pods">decommission operation</a> would need to be performed.</p>

<h3 id="custom-update-plans">
<a id="custom-update-plans" class="anchor" href="#custom-update-plans" aria-hidden="true"><span class="octicon octicon-link"></span></a>Custom Update Plans</h3>

<p>When a configuration change is being rolled out, the Scheduler will by default use the current Deploy plan, whether that’s a custom plan named <code class="highlighter-rouge">deploy</code> or the default deployment plan. Some services require additional logic when performing configuration or software updates, in which case a plan named <code class="highlighter-rouge">update</code> may be provided. The <code class="highlighter-rouge">update</code> plan, if defined, will be used instead of the <code class="highlighter-rouge">deploy</code> plan when rolling out a configuration change. It’s otherwise functionally similar to the custom <code class="highlighter-rouge">deploy</code> logic described above.</p>

<h3 id="custom-auxiliary-plans">
<a id="custom-auxiliary-plans" class="anchor" href="#custom-auxiliary-plans" aria-hidden="true"><span class="octicon octicon-link"></span></a>Custom Auxiliary Plans</h3>

<p>Finally, you may define entirely custom plans which are meant to be invoked by operators. These may define the steps required to perform a backup or restore operation of the service. They may even take additional parameters as input. For example, here is an example plan which will back up a data store to S3:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">pods</span><span class="pi">:</span>
  <span class="na">node</span><span class="pi">:</span>
    <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
      <span class="na">backup-schema</span><span class="pi">:</span>
        <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
      <span class="na">snapshot</span><span class="pi">:</span>
        <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
      <span class="na">upload-s3</span><span class="pi">:</span>
        <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
      <span class="na">cleanup-snapshot</span><span class="pi">:</span>
        <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
<span class="na">plans</span><span class="pi">:</span>
  <span class="pi">[</span><span class="nv">...</span><span class="pi">]</span>
  <span class="na">backup-s3</span><span class="pi">:</span>
    <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
    <span class="na">phases</span><span class="pi">:</span>
      <span class="na">backup-schema</span><span class="pi">:</span>
        <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
        <span class="na">pod</span><span class="pi">:</span> <span class="s">node</span>
        <span class="na">steps</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">default</span><span class="pi">:</span> <span class="pi">[[</span><span class="nv">backup-schema</span><span class="pi">]]</span>
      <span class="na">create-snapshots</span><span class="pi">:</span>
        <span class="na">strategy</span><span class="pi">:</span> <span class="s">parallel</span>
        <span class="na">pod</span><span class="pi">:</span> <span class="s">node</span>
        <span class="na">steps</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">default</span><span class="pi">:</span> <span class="pi">[[</span><span class="nv">snapshot</span><span class="pi">]]</span>
      <span class="na">upload-backups</span><span class="pi">:</span>
        <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
        <span class="na">pod</span><span class="pi">:</span> <span class="s">node</span>
        <span class="na">steps</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">default</span><span class="pi">:</span> <span class="pi">[[</span><span class="nv">upload-s3</span><span class="pi">]]</span>
      <span class="na">cleanup-snapshots</span><span class="pi">:</span>
        <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
        <span class="na">pod</span><span class="pi">:</span> <span class="s">node</span>
        <span class="na">steps</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">default</span><span class="pi">:</span> <span class="pi">[[</span><span class="nv">cleanup-snapshot</span><span class="pi">]]</span>
</code></pre></div></div>

<p>In this example, four Tasks were defined in the <code class="highlighter-rouge">node</code> pod to perform the four steps necessary to back up this service. These tasks were named <code class="highlighter-rouge">backup-schema</code>, <code class="highlighter-rouge">snapshot</code>, <code class="highlighter-rouge">upload-s3</code>, and <code class="highlighter-rouge">cleanup-snapshot</code>. These Tasks are then listed in the <code class="highlighter-rouge">backup-s3</code> Plan as Steps. Each of the Tasks has a shell script which performs the work, optionally using environment variables provided by the operator. The operator invokes the <code class="highlighter-rouge">backup-s3</code> plan and provides any such parameters via repeated <code class="highlighter-rouge">-p</code> arguments:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ dcos myservice plan start backup-s3 \
    -p BACKUP_NAME=mybackup \
    -p BACKUP_TABLES=criticaldata \
    -p AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID \
    -p AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY \
    -p AWS_REGION=$AWS_REGION \
    -p S3_BUCKET_NAME=$S3_BUCKET_NAME
</code></pre></div></div>

<p>Any parameters passed via <code class="highlighter-rouge">-p</code> are automatically passed though to the invoked Tasks as environment variables. Service developers must separately document any such parameters so that users know what to provide.</p>

<h3 id="programmatic-plan-modification">
<a id="programmatic-plan-modification" class="anchor" href="#programmatic-plan-modification" aria-hidden="true"><span class="octicon octicon-link"></span></a>Programmatic Plan Modification</h3>

<p>There are some scenarios which cannot be modeled given the YAML plan specifications described above.  In these scenarios it is possible to programmatically modify plans through implementation of the <code class="highlighter-rouge">PlanCustomizer</code> interface.  For example one could reverse the order of the deploy plan’s phases based on an environment variable.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReverseDeployPhases</span> <span class="kd">implements</span> <span class="n">PlanCustomizer</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Plan</span> <span class="nf">updatePlan</span><span class="o">(</span><span class="n">Plan</span> <span class="n">plan</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">plan</span><span class="o">.</span><span class="na">isDeployPlan</span><span class="o">()</span> <span class="o">&amp;&amp;</span> <span class="n">Boolean</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getenv</span><span class="o">(</span><span class="s">"REVERSE"</span><span class="o">)))</span> <span class="o">{</span>
            <span class="n">Collections</span><span class="o">.</span><span class="na">reverse</span><span class="o">(</span><span class="n">plan</span><span class="o">.</span><span class="na">getChildren</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">plan</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Implementations of this interface are called once for each plan at scheduler startup time before plans begin execution.  If no modification of a particular plan is desired it should be returned unaltered.  A <code class="highlighter-rouge">PlanCustomizer</code> implementation may be specified when building a scheduler with a <code class="highlighter-rouge">SchedulerBuilder</code>.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">SchedulerBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">DefaultScheduler</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">(</span><span class="n">serviceSpec</span><span class="o">,</span> <span class="n">SchedulerConfig</span><span class="o">.</span><span class="na">fromEnv</span><span class="o">())</span>
    <span class="o">.</span><span class="na">setPlanCustomizer</span><span class="o">(</span><span class="k">new</span> <span class="n">ReverseDeployPhases</span><span class="o">());</span>
</code></pre></div></div>

<p>The uninstall plan may also be modified by overriding PlanCustomizer.updateUninstallPlan.</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReverseDeployPhases</span> <span class="kd">implements</span> <span class="n">PlanCustomizer</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Plan</span> <span class="nf">updatePlan</span><span class="o">(</span><span class="n">Plan</span> <span class="n">plan</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">plan</span><span class="o">.</span><span class="na">isDeployPlan</span><span class="o">()</span> <span class="o">&amp;&amp;</span>
            <span class="n">Boolean</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">System</span><span class="o">.</span><span class="na">getenv</span><span class="o">(</span><span class="s">"REVERSE"</span><span class="o">)))</span> <span class="o">{</span>
            <span class="n">Collections</span><span class="o">.</span><span class="na">reverse</span><span class="o">(</span><span class="n">plan</span><span class="o">.</span><span class="na">getChildren</span><span class="o">());</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">plan</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Plan</span> <span class="nf">updateUninstallPlan</span><span class="o">(</span><span class="n">Plan</span> <span class="n">uninstallPlan</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">// Do some clever things</span>

        <span class="k">return</span> <span class="n">uninstallPlan</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h2 id="packaging">
<a id="packaging" class="anchor" href="#packaging" aria-hidden="true"><span class="octicon octicon-link"></span></a>Packaging</h2>

<p>A DC/OS service must provide a package definition in order to be installed on a DC/OS cluster. At a minimum, a package definition is composed of four files: <code class="highlighter-rouge">marathon.json.mustache</code>, <code class="highlighter-rouge">config.json</code>, <code class="highlighter-rouge">resource.json</code>, and <code class="highlighter-rouge">package.json</code>. <a href="https://github.com/mesosphere/dcos-commons/tree/master/frameworks/helloworld/universe">Examples of all these files</a> are provided in the example helloworld DC/OS service.  A detailed explanation of the format and purpose of each of these files is <a href="https://github.com/mesosphere/universe#creating-a-package">available here</a>.</p>

<h3 id="universe-package-files-at-a-glance">
<a id="universe-package-files-at-a-glance" class="anchor" href="#universe-package-files-at-a-glance" aria-hidden="true"><span class="octicon octicon-link"></span></a>Universe Package Files At-a-Glance</h3>

<p>For a fully detailed explanation of service packaging <a href="https://dcos.io/docs/1.8/development/create-package/">see here</a>; below we provide a brief introduction to the required files.</p>

<ul>
  <li>
    <p><code class="highlighter-rouge">marathon.json.mustache</code> - A mustache-templated file that provides a Marathon application definition.  Its mustache elements are rendered by the values present in the config.json and resource.json files.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">resource.json</code> - A list of URIs of all downloaded elements. Any artifacts needed by your service <em>must</em> be listed here, or else your service will fail to install to airgapped clusters. When an airgapped cluster installs your package, only the files listed here will be available. This list contains some items required in order for the service to run along with <code class="highlighter-rouge">bootstrap.zip</code> (bootstrap utility described elsewhere in this guide).</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">command.json</code> - This file contains elements specific to a CLI for your service if you want to provide one.</p>
  </li>
  <li>
    <p><code class="highlighter-rouge">package.json</code> - This file contains metadata of interest to the Universe, including the minimum version of DC/OS on which the service may be deployed.</p>
  </li>
</ul>

<p>The SDK provides utilities for building a package definition and deploying it to a DC/OS cluster for development purposes.  An example build.sh script constructs a package and provides instructions for the deployment.  The helloworld framework’s build.sh script provides the following output:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>./build.sh aws
&lt;snip&gt;
Install your package using the following commands:
dcos package repo remove hello-world-aws
dcos package repo add <span class="nt">--index</span><span class="o">=</span>0 hello-world-aws https://infinity-artifacts.s3.amazonaws.com/autodelete7d/hello-world/20161212-160559-ATLFk70vPlo45X4a/stub-universe-hello-world.zip
dcos package <span class="nb">install</span> <span class="nt">--yes</span> hello-world
</code></pre></div></div>

<p>The build.sh script takes an optional argument of aws or local:</p>

<ul>
  <li>
<code class="highlighter-rouge">./build.sh aws</code>: The package definition and build artifacts are uploaded to an S3 bucket in AWS. If you would like to override the S3 bucket location where the packages are uploaded, please add S3_BUCKET environment variable with the bucket name. For example:</li>
</ul>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">export </span><span class="nv">S3_BUCKET</span><span class="o">=</span>my_universe_s3_bucket
</code></pre></div></div>

<ul>
  <li>
<code class="highlighter-rouge">./build.sh local</code>: The package definition and build artifacts are served by a local HTTP server.</li>
</ul>

<p>Executing the final command, <code class="highlighter-rouge">dcos package install --yes hello-world</code> deploys the service to a DC/OS cluster.</p>

<h1 id="basic-operations">
<a id="basic-operations" class="anchor" href="#basic-operations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Basic Operations</h1>

<p>You can perform three fundamental operations on any instance of a DC/OS service: install, update, and uninstall.  With the exception of uninstall, they all follow a fundamental design principle.</p>

<p>All services written with the SDK determine what actions to take based on a target configuration they are trying to reach.  The <code class="highlighter-rouge">ServiceSpec</code> defines the target configuration. When installing for the first time, a service is going from nothing to the target configuration. When performing a configuration update, a service is going from the current configuration to the target configuration. A software update is identical to a configuration update except that that the software artifacts to be deployed are changed, not just the configuration. The path a service takes to a new target configuration is always defined by a plan.</p>

<p>The following events occur to select a target configuration and move a service from its current configuration to the target.</p>

<ol>
  <li>Define a target configuration
 a. Deploy a Marathon application definition for your service’s scheduler.
 b. The scheduler renders the <code class="highlighter-rouge">ServiceSpec</code> and Plan definitions in the service’s YAML definition.</li>
  <li>Plan Execution
 a. The scheduler compares previous and current <code class="highlighter-rouge">ServiceSpec</code>s:
     i. Validate the <code class="highlighter-rouge">ServiceSpec</code>.
     ii. Determine scenario (install, update or no change).
 b. The plan is chosen and executed.</li>
</ol>

<p>These steps are discussed in more detail below.</p>

<h2 id="defining-a-target-configuration">
<a id="defining-a-target-configuration" class="anchor" href="#defining-a-target-configuration" aria-hidden="true"><span class="octicon octicon-link"></span></a>Defining a Target Configuration</h2>

<p>We previously described how a DC/OS service’s scheduler is a Marathon application.  Marathon applications define a particular declarative application definition, and DC/OS services constructed with the SDK define another, the <code class="highlighter-rouge">ServiceSpec</code>s and plans.</p>

<p>This nested structure of declarative interfaces requires two layers of template rendering. First, the Marathon application definition must be rendered at initial install time from the combination of the marathon.json.mustache, config.json, and resource.json files. Then, the service’s YAML template is rendered using the environment variables presented to the scheduler. Let’s walk through the <a href="https://github.com/mesosphere/dcos-commons/tree/master/frameworks/helloworld">checked-in helloworld example</a>.  Pay particular attention to the templated values surrounded in curly braces, as in <code class="highlighter-rouge">{{value}}</code>.</p>

<p>helloworld has a <a href="https://github.com/mesosphere/dcos-commons/blob/master/frameworks/helloworld/universe/marathon.json.mustache">marathon.json.mustache template</a> which, in part, looks as follows:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "env": {
        "FRAMEWORK_NAME": "{{service.name}}",
        "HELLO_COUNT": "{{hello.count}}",
        "HELLO_CPUS": "{{hello.cpus}}",
        "...": "..."
    },
    "uris": [
        "{{resource.assets.uris.scheduler-zip}}",
        "..."
    ],
    "portDefinitions": [
        {
            "port": 0,
            "protocol": "tcp",
            "name": "api"
        }
    ],
    "...": "..."
}
</code></pre></div></div>

<p>The <a href="https://github.com/mesosphere/dcos-commons/blob/master/frameworks/helloworld/universe/config.json">config.json</a> file is in part:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "type":"object",
    "properties":{
        "service":{
            "type":"object",
            "description": "DC/OS service configuration properties",
            "properties":{
                "name" : {
                    "description":"The name of the service instance",
                    "type":"string",
                    "default":"hello-world"
                },
                "...": "..."
            }
        },
        "hello":{
            "type":"object",
            "description":"Hello Pod configuration properties",
            "properties":{
                "cpus":{
                    "description":"Hello Pod cpu requirements",
                    "type":"number",
                    "default":0.1
                },
                "count":{
                    "description":"Number of Hello Pods to run",
                    "type":"integer",
                    "default":1
                },
                "...": "..."
            }
        }
    }
}
</code></pre></div></div>

<p>The <a href="https://github.com/mesosphere/dcos-commons/blob/master/frameworks/helloworld/universe/resource.json">resource.json</a> file is in part:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
  "assets": {
    "uris": {
      "scheduler-zip": "{{artifact-dir}}/hello-world-scheduler.zip",
      "...": "..."
    }
  },
  "...": "..."
}
</code></pre></div></div>

<p>The <code class="highlighter-rouge">marathon.json.mustache</code> template pulls values from <code class="highlighter-rouge">config.json</code> and <code class="highlighter-rouge">resource.json</code> and creates an initial Marathon application definition. This application definition can be deployed on Marathon, which installs a DC/OS service’s scheduler. You can <a href="https://docs.mesosphere.com/1.9/deploying-services/config-universe-service/">override the initial config.json values when installing via the command line</a>.</p>

<p><strong>Important:</strong> The environment variable field of the Marathon application definition defines values specific to the helloworld service.</p>

<p>The following is the typical flow of configuration values as represented by environment variables:</p>

<p><img src="/dcos-commons/img/dev-guide-configuration-values-across-files.png" alt="configuration values across files"></p>

<p>Once Marathon deploys your scheduler, the service’s YAML specification can be rendered by the environment variables you provided. The helloworld’s service definition is in part:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">// ...</span>
<span class="na">pods</span><span class="pi">:</span>
    <span class="na">hello</span><span class="pi">:</span>
        <span class="na">count</span><span class="pi">:</span> <span class="pi">{{</span><span class="nv">HELLO_COUNT</span><span class="pi">}}</span>
        <span class="na">tasks</span><span class="pi">:</span>
            <span class="na">server</span><span class="pi">:</span>
                <span class="s">// ...</span>
                <span class="s">cpus</span><span class="pi">:</span> <span class="pi">{{</span><span class="nv">HELLO_CPUS</span><span class="pi">}}</span>
                <span class="s">// ...</span>
</code></pre></div></div>

<p>The port definition in <code class="highlighter-rouge">marathon.json.mustache</code> makes the <code class="highlighter-rouge">PORT0</code> environment variables available to the scheduler. The <code class="highlighter-rouge">HELLO_COUNT</code> and <code class="highlighter-rouge">HELLO_CPUS</code> environment variables are provided by the env field of the Marathon application definition, which is provided by the rendered <code class="highlighter-rouge">marathon.json.mustache</code> template.</p>

<p><a name="rendered-spec"></a>
The final rendered <code class="highlighter-rouge">ServiceSpec</code> is:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">hello-container-path/output</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">0.1</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
        <span class="na">volume</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-container-path"</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">ROOT</span>
          <span class="na">size</span><span class="pi">:</span> <span class="s">50</span>
</code></pre></div></div>

<h2 id="plan-execution">
<a id="plan-execution" class="anchor" href="#plan-execution" aria-hidden="true"><span class="octicon octicon-link"></span></a>Plan Execution</h2>

<h3 id="plan-acceptance-or-rejection">
<a id="plan-acceptance-or-rejection" class="anchor" href="#plan-acceptance-or-rejection" aria-hidden="true"><span class="octicon octicon-link"></span></a>Plan Acceptance or Rejection</h3>

<p>Once a proposed target configuration has been defined in the form of a <code class="highlighter-rouge">ServiceSpec</code>, and, optionally, a deployment plan, the scheduler must decide  what course of action to take. At the outset, a scheduler may choose to accept or reject a proposed target configuration. When a scheduler rejections a proposed target configuration the target configuration does  not change and the previous target configuration remains the target. The scheduler may reject a target configuration because it is malformed, or violates a business logic or other constraint.</p>

<h3 id="executing-a-plan">
<a id="executing-a-plan" class="anchor" href="#executing-a-plan" aria-hidden="true"><span class="octicon octicon-link"></span></a>Executing a Plan</h3>

<p>Once a proposed target configuration is accepted as the target configuration, the scheduler must determine which plan to execute to reach the target. By default, if no overriding deployment plan is provided, the pods defined in the <code class="highlighter-rouge">ServiceSpec</code> will be rolled out serially.</p>

<p>There are two fundamental plan execution scenarios: <strong>install</strong> and <strong>update</strong>.  Let’s first walk through the deployment of the <a href="https://github.com/mesosphere/dcos-commons/blob/master/frameworks/helloworld/src/main/dist/svc.yml">hello world service</a> in the install case.</p>

<h3 id="install">
<a id="install" class="anchor" href="#install" aria-hidden="true"><span class="octicon octicon-link"></span></a>Install</h3>

<p>Recall the <a href="#rendered-spec">rendered <code class="highlighter-rouge">ServiceSpec</code> from above</a>. A single pod containing a single task is defined generating the following plan:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "phases": [{
        "id": "8ee5b023-066e-4ef7-a2c9-5fdfc00a50e5",
        "name": "hello",
        "steps": [{
            "id": "2e3dde39-3ea3-408b-8e00-3346bef93054",
            "status": "COMPLETE",
            "name": "hello-0:[server]",
            "message": "'hello-0:[server]' has status: 'COMPLETE'."
        }],
        "status": "COMPLETE"
    }],
    "errors": [],
    "status": "COMPLETE"
}
</code></pre></div></div>

<p>Each pod is deployed with a phase, so we have a single phase named after the pod “hello”.  Each instance of a pod is deployed with a step within that phase. Since there is a single pod instance, we have a single step named “hello-0:[server]”.  The name of the step indicates that it is deploying instance 0 of the pod “hello” with a single task named “server”.</p>

<p>Every element of the plan has an associated status with the following possible values: PENDING, PREPARED, STARTING, COMPLETE, WAITING, and ERROR.</p>

<p>Normally, steps progress through statuses in the following order:</p>

<p>PENDING → PREPARED → STARTING → COMPLETE</p>

<p>The status of a phase or a plan is determined by examination of the step elements.  A step may enter an ERROR state when its construction is malformed or whenever the service author determines it to be appropriate. The WAITING state occurs when the operator of the service indicates that an element should be paused. An operator might want to pause a deployment for a multitude of reasons, including unexpected failures during an update.</p>

<h3 id="update">
<a id="update" class="anchor" href="#update" aria-hidden="true"><span class="octicon octicon-link"></span></a>Update</h3>

<p>In the update case, a scheduler goes from one target configuration to the next. The two examples below show how pods are only restarted to consume new configuration information when that information is relevant to the pod.</p>

<h4 id="vertical-scale-example">
<a id="vertical-scale-example" class="anchor" href="#vertical-scale-example" aria-hidden="true"><span class="octicon octicon-link"></span></a>Vertical Scale Example</h4>

<p>This example updates the target configuration we defined in the install above. The new target configuration below increases the amount of CPU consumed by the server task.</p>

<p>In the <code class="highlighter-rouge">marathon.json.mustache</code> template we defined an environment variable named <code class="highlighter-rouge">HELLO_CPUS</code>. Below, we update this value in Marathon from <code class="highlighter-rouge">0.1</code> to <code class="highlighter-rouge">0.2</code>.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "id": "/hello-world",
    "env": {
        "HELLO_CPUS": "0.2",
        "HELLO_COUNT": "1",
        "SLEEP_DURATION": "1000",
        "...": "..."
    },
    "...": "..."
}
</code></pre></div></div>

<p>This will result in restarting the scheduler and re-rendering the <code class="highlighter-rouge">ServiceSpec</code> template. The new template is shown below, with the value of <code class="highlighter-rouge">cpus</code> changed to <code class="highlighter-rouge">0.2</code>.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">hello-container-path/output</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">0.2</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
        <span class="na">volume</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-container-path"</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">ROOT</span>
          <span class="na">size</span><span class="pi">:</span> <span class="s">50</span>
</code></pre></div></div>

<p>This generates the following <code class="highlighter-rouge">deploy</code> Plan:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "phases": [{
        "id": "ce7bf2e6-857d-4188-a21c-6469c2db92fb",
        "name": "hello",
        "steps": [{
            "id": "c47bf620-9cd7-4bae-b9d0-f56ca00e26ce",
            "status": "STARTING",
            "name": "hello-0:[server]",
            "message": "'hello-0:[server]' has status: 'STARTING'."
        }],
        "status": "STARTING"
    }],
    "errors": [],
    "status": "STARTING"
}
</code></pre></div></div>

<p>In this case, we have changed the resources consumed for a running task. The task must be killed and then restarted with an updated resource reservation. When the Step for a task is in the <code class="highlighter-rouge">PREPARED</code> state, the task has been killed and will be restarted as soon as the appropriate resources are available. Once the task is successfully relaunched with the increased resource allocation to reflect the new target configuration, the <code class="highlighter-rouge">deploy</code> Plan will be in a <code class="highlighter-rouge">COMPLETE</code> state.</p>

<h4 id="horizontal-scale-example">
<a id="horizontal-scale-example" class="anchor" href="#horizontal-scale-example" aria-hidden="true"><span class="octicon octicon-link"></span></a>Horizontal Scale Example</h4>

<p>In the previous example, the change in target configuration affected currently running tasks, so they had to be restarted. In this example, we are changing the number of pod instances to be launched, which should have no effect on currently running pods and therefore will not trigger a restart. The example below increases <code class="highlighter-rouge">HELLO_COUNT</code> to <code class="highlighter-rouge">2</code>, adding an additional instance of the hello pod.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "id": "/hello-world",
    "env": {
        "HELLO_CPUS": "0.2",
        "HELLO_COUNT": "2",
        "SLEEP_DURATION": "1000",
        "...": "..."
    },
    "...": "..."
}
</code></pre></div></div>

<p>This generates the following <code class="highlighter-rouge">deploy</code> Plan:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>{
    "phases": [{
        "id": "25e741c8-a775-481e-9247-d9073002bb3d",
        "name": "hello",
        "steps": [{
            "id": "6780372e-9154-419b-91c4-e0347ca961af",
            "status": "COMPLETE",
            "name": "hello-0:[server]",
            "message": "'hello-0:[server]' has status: 'COMPLETE'."
        }, {
            "id": "6e519f31-8e2d-41ea-955d-85fdd7e1d624",
            "status": "PENDING",
            "name": "hello-1:[server]",
            "message": "'hello-1:[server]' has status: 'PENDING'."
        }],
        "status": "STARTING"
    }],
    "errors": [],
    "status": "STARTING"
}
</code></pre></div></div>

<p>Because instance 0 of the hello pod is unaffected by the increase in pod count, we see that <code class="highlighter-rouge">hello-0</code> is never restarted and its step is initialized as <code class="highlighter-rouge">COMPLETE</code>. Another step named <code class="highlighter-rouge">hello-1</code> has been generated for instance 1. Once <code class="highlighter-rouge">hello-1</code> has been deployed, the service will have transitioned from its previous configuration to the new target configuration, and the above <code class="highlighter-rouge">deploy</code> Plan will be in a <code class="highlighter-rouge">COMPLETE</code> state. <strong>Note:</strong> By default, pods can be scaled up but not scaled down. Decreasing the number of pods will result in a validation error when the Scheduler is restarted. As a safety measure, if you wish to allow scale-in of your pods, you must specify <code class="highlighter-rouge">allow-decommission: true</code> for each applicable pod.</p>

<h3 id="rollback">
<a id="rollback" class="anchor" href="#rollback" aria-hidden="true"><span class="octicon octicon-link"></span></a>Rollback</h3>

<p>A special rollback operation is not defined. To roll back a given deployment, deploy the previous configuration as the new target.</p>

<h3 id="software-upgrade">
<a id="software-upgrade" class="anchor" href="#software-upgrade" aria-hidden="true"><span class="octicon octicon-link"></span></a>Software Upgrade</h3>

<p>Like rollback, a special software upgrade operation is not defined. To perform an upgrade, just specify a new target configuration. When performing an upgrade, you are probably creating a target configuration that refers to new URIs with new software to launch tasks. This target configuration change is rolled out like any other update.</p>

<h3 id="api">
<a id="api" class="anchor" href="#api" aria-hidden="true"><span class="octicon octicon-link"></span></a>API</h3>

<h4 id="view">
<a id="view" class="anchor" href="#view" aria-hidden="true"><span class="octicon octicon-link"></span></a>View</h4>

<p>You can view the deployment plan via a REST endpoint your scheduler provides. The plans shown in the examples above were accessed by:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-k</span> <span class="nt">-H</span> <span class="s2">"Authorization: token=</span><span class="nv">$AUTH_TOKEN</span><span class="s2">"</span> http://&lt;dcos_url&gt;/service/hello-world/v1/plans/deploy
</code></pre></div></div>

<h4 id="interrupt">
<a id="interrupt" class="anchor" href="#interrupt" aria-hidden="true"><span class="octicon octicon-link"></span></a>Interrupt</h4>

<p>You can interrupt the execution of a plan by issuing a <code class="highlighter-rouge">POST</code> request to the appropriate endpoint:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-k</span> <span class="nt">-X</span> POST <span class="nt">-H</span> <span class="s2">"Authorization: token=</span><span class="nv">$AUTH_TOKEN</span><span class="s2">"</span> http://&lt;dcos_url&gt;/service/hello-world/v1/plans/deploy/interrupt
</code></pre></div></div>

<p>Interrupting a plan stops any steps that were not being processed from being processed in the future. Any steps that were actively being processed at the time of an interrupt call will continue.</p>

<p>The interrupt may also be issued against a specific phase within the plan:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-k</span> <span class="nt">-X</span> POST <span class="nt">-H</span> <span class="s2">"Authorization: token=</span><span class="nv">$AUTH_TOKEN</span><span class="s2">"</span> http://&lt;dcos_url&gt;/service/hello-world/v1/plans/deploy/interrupt?phase<span class="o">=</span>data-nodes
</code></pre></div></div>

<p>Interrupting a phase of a plan only stops the steps within that phase, without affecting other phases.</p>

<h4 id="continue">
<a id="continue" class="anchor" href="#continue" aria-hidden="true"><span class="octicon octicon-link"></span></a>Continue</h4>

<p>Continue plan execution by issuing a <code class="highlighter-rouge">POST</code> request to the continue endpoint:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-k</span> <span class="nt">-X</span> POST <span class="nt">-H</span> <span class="s2">"Authorization: token=</span><span class="nv">$AUTH_TOKEN</span><span class="s2">"</span> http://&lt;dcos_url&gt;/service/hello-world/v1/plans/deploy/continue
</code></pre></div></div>

<p>Continue may also be issued on a per-phase basis:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-k</span> <span class="nt">-X</span> POST <span class="nt">-H</span> <span class="s2">"Authorization: token=</span><span class="nv">$AUTH_TOKEN</span><span class="s2">"</span> http://&lt;dcos_url&gt;/service/hello-world/v1/plans/deploy/continue?phase<span class="o">=</span>data-nodes
</code></pre></div></div>

<h1 id="service-discovery">
<a id="service-discovery" class="anchor" href="#service-discovery" aria-hidden="true"><span class="octicon octicon-link"></span></a>Service Discovery</h1>

<p>There are two service discovery options that are relevant to the SDK: mesos-dns and VIPs.  Mesos-dns provides a stable, predictable address for individual Mesos tasks.  VIPs provide a load balancing mechanism across multiple instances of a class of tasks.</p>

<h2 id="mesos-dns">
<a id="mesos-dns" class="anchor" href="#mesos-dns" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="https://github.com/mesosphere/mesos-dns">Mesos-DNS</a>
</h2>

<p>All tasks launched in DC/OS receive a DNS address. It is of the form:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;task-name&gt;.&lt;framework-name&gt;.autoip.dcos.thisdcos.directory
</code></pre></div></div>

<p>So a service defined as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">hello-container-path/output</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">0.2</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
        <span class="na">volume</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-container-path"</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">ROOT</span>
          <span class="na">size</span><span class="pi">:</span> <span class="s">50</span>
</code></pre></div></div>

<p>would generate a single task named “hello-0-server”.  The framework’s name is “hello-world”.  The Mesos-DNS address for this task would be “hello-0-server.hello-world.autoip.dcos.thisdcos.directory”. Tasks may also specify their own prefixes for the first component of their mesos-dns names using the <code class="highlighter-rouge">discovery</code> section in each task definition. In the following example, two tasks within the same pod share a prefix:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">resource-sets</span><span class="pi">:</span>
      <span class="na">pod-resources</span><span class="pi">:</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">0.2</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
        <span class="na">volume</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-container-path"</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">ROOT</span>
          <span class="na">size</span><span class="pi">:</span> <span class="s">50</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">init</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">ONCE</span>
        <span class="na">resource-set</span><span class="pi">:</span> <span class="s">pod-resources</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">init</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">hello-container-path/output</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span>
        <span class="na">discovery</span><span class="pi">:</span>
          <span class="na">prefix</span><span class="pi">:</span> <span class="s">hello</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">resource-set</span><span class="pi">:</span> <span class="s">pod-resources</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">hello-container-path/output</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span>
        <span class="na">discovery</span><span class="pi">:</span>
          <span class="na">prefix</span><span class="pi">:</span> <span class="s">hello</span>
</code></pre></div></div>

<p>In this case, while running, both the <code class="highlighter-rouge">init</code> and <code class="highlighter-rouge">server</code> tasks would be addressable at “hello-0.hello-world.autoip.dcos.thisdcos.directory”, with the “-0” being added automatically to indicate which pod instance to route to. Tasks belonging to different pods may not share the same prefix, and YAML validation will fail if this is found to be the case.</p>

<p><strong>Important:</strong> As with resource sets, only a single process at point in time may use a given prefix, meaning that <code class="highlighter-rouge">init</code> may not run at the same time as <code class="highlighter-rouge">server</code>. A complete service definition would have a deploy plan that ensures this.</p>

<h2 id="vip">
<a id="vip" class="anchor" href="#vip" aria-hidden="true"><span class="octicon octicon-link"></span></a><a href="https://github.com/dcos/minuteman">VIP</a>
</h2>

<p>You can also perform service discovery by defining named virtual IP addresses. VIPs load balance, so every task associated with the same prefix and external port pair will be part of a load-balanced set of tasks.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">hello-container-path/output</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">0.2</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
        <span class="na">ports</span><span class="pi">:</span>
            <span class="na">http</span><span class="pi">:</span>
                <span class="na">port</span><span class="pi">:</span> <span class="s">8080</span>
                <span class="na">advertise</span><span class="pi">:</span> <span class="no">true</span>
                <span class="na">vip</span><span class="pi">:</span>
                    <span class="na">prefix</span><span class="pi">:</span> <span class="s">server-lb</span>
                    <span class="na">port</span><span class="pi">:</span> <span class="s">80</span>
</code></pre></div></div>

<p>Defining a VIP is additional information that can be applied to a port. VIPs are defined by a prefix, an internal port, and an external port. The internal port in this example is 8080 and the external port is 80. The prefix is automatically expanded to become an address of the form:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;prefix&gt;.&lt;framework-name&gt;.l4lb.thisdcos.directory
</code></pre></div></div>

<p>In the example above, a server task can be accessed through the address:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server-lb.hello-world.l4lb.thisdcos.directory:80
</code></pre></div></div>

<h2 id="virtual-networks">
<a id="virtual-networks" class="anchor" href="#virtual-networks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Virtual networks</h2>

<p>The SDK allows pods to join virtual networks, with the <code class="highlighter-rouge">dcos</code> virtual network available by default. You can specify that a pod should join the virtual network by adding the following to your service spec YAML:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">pods</span><span class="pi">:</span>
  <span class="na">pod-on-virtual-network</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="pi">{{</span><span class="nv">COUNT</span><span class="pi">}}</span>
    <span class="c1"># join the 'dcos' virtual network</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="na">dcos</span><span class="pi">:</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="s">...</span>
  <span class="na">pod-on-host</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="pi">{{</span><span class="nv">COUNT</span><span class="pi">}}</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="s">...</span>
</code></pre></div></div>

<p>You can also pass arguments when invoking CNI plugins, by adding labels in your virtual network definition. These labels are are free-form key-value pairs that are passed in the format of <code class="highlighter-rouge">key0:value0,key1:value1</code>. Refer to <a href="https://mesos.apache.org/documentation/latest/cni/#mesos-meta-data-to-cni-plugins">Mesos CNI Configuration</a> for more information about CNI labels. Here is a sample YAML definition with labels:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">pods</span><span class="pi">:</span>
  <span class="na">pod-on-virtual-network</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="pi">{{</span><span class="nv">COUNT</span><span class="pi">}}</span>
    <span class="c1"># join the 'dcos' virtual network</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="na">dcos</span><span class="pi">:</span>
        <span class="na">labels</span><span class="pi">:</span> <span class="s2">"</span><span class="s">key0:val0,</span><span class="nv"> </span><span class="s">key1:val1"</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="s">...</span>
  <span class="na">pod-on-host</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="pi">{{</span><span class="nv">COUNT</span><span class="pi">}}</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="s">...</span>
</code></pre></div></div>

<p>When a pod is on a virtual network such as the <code class="highlighter-rouge">dcos</code>:</p>
<ul>
  <li>Every pod gets its own IP address and its own array of ports.</li>
  <li>Pods do not use the ports on the host machine.</li>
  <li>Pod IP addresses can be resolved with the DNS: <code class="highlighter-rouge">&lt;task_name&gt;.&lt;service_name&gt;.autoip.dcos.thisdcos.directory</code>.</li>
  <li>You can pass network labels to CNI plugins.</li>
</ul>

<p>Specifying that pods join a virtual network has the following indirect effects:</p>
<ul>
  <li>The <code class="highlighter-rouge">ports</code> resource requirements in the service spec will be ignored as resource requirements, as each pod has their own dedicated IP namespace.
    <ul>
      <li>This was done so that you do not have to remove all of the port resource requirements just to deploy a service on the virtual network.</li>
    </ul>
  </li>
  <li>A caveat of this is that the SDK does not allow the configuration of a pod to change from the virtual network to the host network or vice-versa.</li>
</ul>

<h2 id="label-based-discovery">
<a id="label-based-discovery" class="anchor" href="#label-based-discovery" aria-hidden="true"><span class="octicon octicon-link"></span></a>Label-Based Discovery</h2>

<p>Some external tools such as <a href="https://docs.traefik.io">Traefik</a> require tasks to be configured with custom labels which are accessed by reading Mesos state. Below is an example of specifying labels for a task in your service spec YAML:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>name: "hello-world"
pods:
  hello:
    count: 1
    tasks:
      server:
        goal: RUNNING
        cmd: "echo hello &gt;&gt; hello-container-path/output &amp;&amp; sleep 1000"
        cpus: 0.2
        memory: 256
        labels: "traefik.enable:true,traefik.frontend.entryPoints:http,traefik.frontend.rule:PathPrefix:/"
        ports:
          http:
          port: 8080
          advertise: true
</code></pre></div></div>

<h1 id="metrics">
<a id="metrics" class="anchor" href="#metrics" aria-hidden="true"><span class="octicon octicon-link"></span></a>Metrics</h1>
<h2 id="default">
<a id="default" class="anchor" href="#default" aria-hidden="true"><span class="octicon octicon-link"></span></a>Default</h2>
<p>Schedulers generate a set of default metrics.  Metrics are reported in three main categories: offers, operations, and status messages.</p>

<h5 id="offers">
<a id="offers" class="anchor" href="#offers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Offers</h5>
<ol>
  <li>Received.</li>
  <li>Processed.</li>
  <li>Decline (long/short).</li>
</ol>

<p>Offers are counted as received as soon as they are offered to the scheduler by Mesos. They are counted as processed after they have been compared against the current work the scheduler needs to do, and then either accepted or rejected.</p>

<p>Declined offers fall into two categories: those that are declined for a long time (1 hour) and those that are declined for a short time (e.g., 5 seconds). In general, offers are declined for a short time when the offer queue is full. They are declined for a long time when they fail to match any of the current work requirements.</p>

<p>The <code class="highlighter-rouge">offers.process</code> timer reports statistics about how long it takes the scheduler to process all offers in the offer queue.</p>

<h5 id="operations">
<a id="operations" class="anchor" href="#operations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Operations</h5>
<p>Mesos has a set of operations that can be performed on offers. These include, for example, <code class="highlighter-rouge">RESERVE</code> and <code class="highlighter-rouge">LAUNCH_GROUP</code>.
The count of all operations is reported.</p>

<h5 id="status">
<a id="status" class="anchor" href="#status" aria-hidden="true"><span class="octicon octicon-link"></span></a>Status</h5>
<p>Mesos has a set of TaskStatus messages that schedulers receive. These include, for example, <code class="highlighter-rouge">TASK_RUNNING</code> and <code class="highlighter-rouge">TASK_FAILED</code>.
The count of all TaskStatus messages is reported.</p>

<h5 id="reporting">
<a id="reporting" class="anchor" href="#reporting" aria-hidden="true"><span class="octicon octicon-link"></span></a>Reporting</h5>
<p>The scheduler’s metrics are reported via three different mechanisms: <code class="highlighter-rouge">JSON</code>, <a href="https://prometheus.io/">prometheus</a> and <a href="https://github.com/etsy/statsd">StatsD</a>. The StatsD metrics are pushed to the address defined by the environment variables <code class="highlighter-rouge">STATSD_UDP_HOST</code> and <code class="highlighter-rouge">STATSD_UDP_PORT</code>. See the <a href="https://dcos.io/docs/1.10/metrics/">DC/OS Metrics documentation</a> for more details.</p>

<p>The JSON representation of the metrics is available at the <code class="highlighter-rouge">/v1/metrics</code> endpoint`.</p>

<h6 id="json">
<a id="json" class="anchor" href="#json" aria-hidden="true"><span class="octicon octicon-link"></span></a>JSON</h6>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
    </span><span class="s2">"version"</span><span class="p">:</span><span class="w"> </span><span class="s2">"3.1.3"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"gauges"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
    </span><span class="s2">"counters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"declines.long"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">15</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"offers.processed"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">18</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"offers.received"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">18</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"operation.create"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">5</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"operation.launch_group"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"operation.reserve"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">20</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"revives"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">3</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="s2">"task_status.task_running"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">6</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="s2">"histograms"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
    </span><span class="s2">"meters"</span><span class="p">:</span><span class="w"> </span><span class="p">{},</span><span class="w">
    </span><span class="s2">"timers"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="s2">"offers.process"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="s2">"count"</span><span class="p">:</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span><span class="w">
            </span><span class="s2">"max"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.684745927</span><span class="p">,</span><span class="w">
            </span><span class="s2">"mean"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.15145255818999337</span><span class="p">,</span><span class="w">
            </span><span class="s2">"min"</span><span class="p">:</span><span class="w"> </span><span class="mf">5.367950000000001E-4</span><span class="p">,</span><span class="w">
            </span><span class="s2">"p50"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.0035879090000000002</span><span class="p">,</span><span class="w">
            </span><span class="s2">"p75"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.40317217800000005</span><span class="p">,</span><span class="w">
            </span><span class="s2">"p95"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.684745927</span><span class="p">,</span><span class="w">
            </span><span class="s2">"p98"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.684745927</span><span class="p">,</span><span class="w">
            </span><span class="s2">"p99"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.684745927</span><span class="p">,</span><span class="w">
            </span><span class="s2">"p999"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.684745927</span><span class="p">,</span><span class="w">
            </span><span class="s2">"stddev"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.24017017290826104</span><span class="p">,</span><span class="w">
            </span><span class="s2">"m15_rate"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.5944843686231079</span><span class="p">,</span><span class="w">
            </span><span class="s2">"m1_rate"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.5250565015924039</span><span class="p">,</span><span class="w">
            </span><span class="s2">"m5_rate"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.583689104996544</span><span class="p">,</span><span class="w">
            </span><span class="s2">"mean_rate"</span><span class="p">:</span><span class="w"> </span><span class="mf">0.3809369986002824</span><span class="p">,</span><span class="w">
            </span><span class="s2">"duration_units"</span><span class="p">:</span><span class="w"> </span><span class="s2">"seconds"</span><span class="p">,</span><span class="w">
            </span><span class="s2">"rate_units"</span><span class="p">:</span><span class="w"> </span><span class="s2">"calls/second"</span><span class="w">
        </span><span class="p">}</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p>The Prometheus representation of the metrics is available at the <code class="highlighter-rouge">/v1/metrics/prometheus</code> endpoint.</p>
<h6 id="prometheus">
<a id="prometheus" class="anchor" href="#prometheus" aria-hidden="true"><span class="octicon octicon-link"></span></a>Prometheus</h6>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code># HELP declines_long Generated from Dropwizard metric import (metric=declines.long, type=com.codahale.metrics.Counter)
# TYPE declines_long gauge
declines_long 20.0
# HELP offers_processed Generated from Dropwizard metric import (metric=offers.processed, type=com.codahale.metrics.Counter)
# TYPE offers_processed gauge
offers_processed 24.0
# HELP offers_received Generated from Dropwizard metric import (metric=offers.received, type=com.codahale.metrics.Counter)
# TYPE offers_received gauge
offers_received 24.0
# HELP operation_create Generated from Dropwizard metric import (metric=operation.create, type=com.codahale.metrics.Counter)
# TYPE operation_create gauge
operation_create 5.0
# HELP operation_launch_group Generated from Dropwizard metric import (metric=operation.launch_group, type=com.codahale.metrics.Counter)
# TYPE operation_launch_group gauge
operation_launch_group 4.0
# HELP operation_reserve Generated from Dropwizard metric import (metric=operation.reserve, type=com.codahale.metrics.Counter)
# TYPE operation_reserve gauge
operation_reserve 20.0
# HELP revives Generated from Dropwizard metric import (metric=revives, type=com.codahale.metrics.Counter)
# TYPE revives gauge
revives 4.0
# HELP task_status_task_finished Generated from Dropwizard metric import (metric=task_status.task_finished, type=com.codahale.metrics.Counter)
# TYPE task_status_task_finished gauge
task_status_task_finished 1.0
# HELP task_status_task_running Generated from Dropwizard metric import (metric=task_status.task_running, type=com.codahale.metrics.Counter)
# TYPE task_status_task_running gauge
task_status_task_running 8.0
# HELP offers_process Generated from Dropwizard metric import (metric=offers.process, type=com.codahale.metrics.Timer)
# TYPE offers_process summary
offers_process{quantile="0.5",} 2.0609500000000002E-4
offers_process{quantile="0.75",} 2.2853200000000001E-4
offers_process{quantile="0.95",} 0.005792643
offers_process{quantile="0.98",} 0.005792643
offers_process{quantile="0.99",} 0.111950848
offers_process{quantile="0.999",} 0.396119612
offers_process_count 244.0
</code></pre></div></div>

<h2 id="custom-metrics">
<a id="custom-metrics" class="anchor" href="#custom-metrics" aria-hidden="true"><span class="octicon octicon-link"></span></a>Custom Metrics</h2>
<p>A service author may choose to expose custom metrics by using the metrics registry. The popular <a href="http://metrics.dropwizard.io">dropwizard metrics library</a> is used.  An instance of a <a href="https://metrics.dropwizard.io/3.1.0/apidocs/com/codahale/metrics/MetricRegistry.html">MetricsRegistry</a> can be acquired in the following way.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">MetricsRegistry</span> <span class="n">registry</span> <span class="o">=</span> <span class="n">Metrics</span><span class="o">.</span><span class="na">getRegistry</span><span class="o">();</span>
</code></pre></div></div>

<p>Use of this registry will guarantee that metrics are reported on all the appropriate interfaces.</p>

<h1 id="secrets">
<a id="secrets" class="anchor" href="#secrets" aria-hidden="true"><span class="octicon octicon-link"></span></a>Secrets</h1>

<p>Enterprise DC/OS provides a secrets store to enable access to sensitive data such as database passwords, private keys, and API tokens. DC/OS manages secure transportation of secret data, access control and authorization, and secure storage of secret content.</p>

<p><strong>Note:</strong> The SDK supports secrets in Enterprise DC/OS 1.10 onwards (not in Enterprise DC/OS 1.9). <a href="https://docs.mesosphere.com/1.10/security/secrets/">Learn more about the secrets store</a>.</p>

<p>The SDK allows secrets to be exposed to pods as a file and/or as an environment variable. The content of a secret is copied and made available within the pod.</p>

<p>You can reference the secret as a file if your service needs to read secrets from files mounted in the container. Referencing a file-based secret can be particularly useful for:</p>
<ul>
  <li>Kerberos keytabs or other credential files.</li>
  <li>SSL certificates.</li>
  <li>Configuration files with sensitive data.</li>
</ul>

<p>For the following example, a file with path <code class="highlighter-rouge">data/somePath/Secret_FilePath1</code> relative to the sandbox will be created. Also, the value of the environment variable <code class="highlighter-rouge">Secret_Environment_Key1</code> will be set to the content of this secret. Secrets are referenced with a path, i.e. <code class="highlighter-rouge">secret-svc/SecretPath1</code>, as shown below.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s">secret-svc/instance1</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">pod-with-secret</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="pi">{{</span><span class="nv">COUNT</span><span class="pi">}}</span>
    <span class="c1"># add secret file to pod's sandbox</span>
    <span class="na">secrets</span><span class="pi">:</span>
      <span class="na">secret_name1</span><span class="pi">:</span>
        <span class="na">secret</span><span class="pi">:</span> <span class="s">secret-svc/Secret_Path1</span>
        <span class="na">env-key</span><span class="pi">:</span> <span class="s">Secret_Environment_Key</span>
        <span class="na">file</span><span class="pi">:</span> <span class="s">data/somePath/Secret_FilePath1</span>
      <span class="na">secret_name2</span><span class="pi">:</span>
        <span class="na">secret</span><span class="pi">:</span> <span class="s">secret-svc/instance1/Secret_Path2</span>
        <span class="na">file</span><span class="pi">:</span> <span class="s">data/somePath/Secret_FilePath2</span>
      <span class="na">secret_name3</span><span class="pi">:</span>
        <span class="na">secret</span><span class="pi">:</span> <span class="s">secret-svc/Secret_Path3</span>
        <span class="na">env-key</span><span class="pi">:</span> <span class="s">Secret_Environment_Key2</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="s">....</span>
</code></pre></div></div>

<p>All tasks defined in the pod will have access to secret data. If the content of the secret is changed, the relevant pod needs to be restarted so that it can get updated content from the secret store.</p>

<p><code class="highlighter-rouge">env-key</code> or <code class="highlighter-rouge">file</code> can be left empty. The secret file is a tmpfs file; it disappears when the executor exits. The secret content is copied securely by Mesos if it is referenced in the pod definition as shown above. You can make a secret available as an environment variable, as a file in the sandbox, or you can use both.</p>

<p><strong>Note:</strong> Secrets are available only in Enterprise DC/OS, not in OSS DC/OS.</p>

<p>Refer to the <a href="../tutorials/secrets-tutorial/">Secrets Tutorial</a> for an
SDK-based example service using DC/OS secrets.</p>

<h3 id="authorization-for-secrets">
<a id="authorization-for-secrets" class="anchor" href="#authorization-for-secrets" aria-hidden="true"><span class="octicon octicon-link"></span></a>Authorization for Secrets</h3>

<p>The path of a secret defines which service IDs can have access to it. You can think of secret paths as namespaces. <em>Only</em> services that are under the same namespace can read the content of the secret.</p>

<p>For the example given above, the secret with path <code class="highlighter-rouge">secret-svc/Secret_Path1</code> can only be accessed by a services with ID <code class="highlighter-rouge">/secret-svc</code> or any service with  ID under <code class="highlighter-rouge">/secret-svc/</code>. Services with IDs <code class="highlighter-rouge">/secret-svc/dev1</code> and <code class="highlighter-rouge">/secret-svc/instance2/dev2</code> all have access to this secret, because they are under <code class="highlighter-rouge">/secret-svc/</code>.</p>

<p>On the other hand, the secret with path <code class="highlighter-rouge">secret-svc/instance1/Secret_Path2</code> cannot be accessed by a service with ID <code class="highlighter-rouge">/secret-svc</code> because it is not <em>under</em> this secret’s namespace, which is <code class="highlighter-rouge">/secret-svc/instance1</code>. <code class="highlighter-rouge">secret-svc/instance1/Secret_Path2</code> can be accessed by a service with ID <code class="highlighter-rouge">/secret-svc/instance1</code> or any service with ID under <code class="highlighter-rouge">/secret-svc/instance1/</code>, for example <code class="highlighter-rouge">/secret-svc/instance1/dev3</code> and <code class="highlighter-rouge">/secret-svc/instance1/someDir/dev4</code>.</p>

<table>
  <thead>
    <tr>
      <th>Secret</th>
      <th>Service ID</th>
      <th>Can service access secret?</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">secret-svc/Secret_Path1</code></td>
      <td><code class="highlighter-rouge">/user</code></td>
      <td>No</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">secret-svc/Secret_Path1</code></td>
      <td><code class="highlighter-rouge">/user/dev1</code></td>
      <td>No</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">secret-svc/Secret_Path1</code></td>
      <td><code class="highlighter-rouge">/secret-svc</code></td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">secret-svc/Secret_Path1</code></td>
      <td><code class="highlighter-rouge">/secret-svc/dev1</code></td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">secret-svc/Secret_Path1</code></td>
      <td><code class="highlighter-rouge">/secret-svc/instance2/dev2</code></td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">secret-svc/Secret_Path1</code></td>
      <td><code class="highlighter-rouge">/secret-svc/a/b/c/dev3</code></td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">secret-svc/instance1/Secret_Path2</code></td>
      <td><code class="highlighter-rouge">/secret-svc/dev1</code></td>
      <td>No</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">secret-svc/instance1/Secret_Path2</code></td>
      <td><code class="highlighter-rouge">/secret-svc/instance2/dev3</code></td>
      <td>No</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">secret-svc/instance1/Secret_Path2</code></td>
      <td><code class="highlighter-rouge">/secret-svc/instance1</code></td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">secret-svc/instance1/Secret_Path2</code></td>
      <td><code class="highlighter-rouge">/secret-svc/instance1/dev3</code></td>
      <td>Yes</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">secret-svc/instance1/Secret_Path2</code></td>
      <td><code class="highlighter-rouge">/secret-svc/instance1/someDir/dev3</code></td>
      <td>Yes</td>
    </tr>
  </tbody>
</table>

<p><strong>Note:</strong> Absolute paths (paths with a leading slash) to secrets are not supported. The file path for a secret must be relative to the sandbox.</p>

<p>Below is a valid secret definition with a Docker <code class="highlighter-rouge">image</code>. The <code class="highlighter-rouge">$MESOS_SANDBOX/etc/keys</code> and <code class="highlighter-rouge">$MESOS_SANDBOX/data/keys/keyset</code> directories will be created if they do not exist.</p>
<ul>
  <li>Supported: <code class="highlighter-rouge">etc/keys/Secret_FilePath1</code>
</li>
  <li>Not supported: <code class="highlighter-rouge">/etc/keys/Secret_FilePath1</code>
</li>
</ul>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s">secret-svc/instance2</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">pod-with-image</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="pi">{{</span><span class="nv">COUNT</span><span class="pi">}}</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">ubuntu:18.04</span>
    <span class="na">user</span><span class="pi">:</span> <span class="s">nobody</span>
    <span class="na">secrets</span><span class="pi">:</span>
      <span class="na">secret_name4</span><span class="pi">:</span>
        <span class="na">secret</span><span class="pi">:</span> <span class="s">secret-svc/Secret_Path1</span>
        <span class="na">env-key</span><span class="pi">:</span> <span class="s">Secret_Environment_Key</span>
        <span class="na">file</span><span class="pi">:</span> <span class="s">etc/keys/Secret_FilePath1</span>
      <span class="na">secret_name5</span><span class="pi">:</span>
        <span class="na">secret</span><span class="pi">:</span> <span class="s">secret-svc/instance1/Secret_Path2</span>
        <span class="na">file</span><span class="pi">:</span> <span class="s">data/keys/keyset/Secret_FilePath2</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="s">....</span>
</code></pre></div></div>

<h1 id="regions-and-zones">
<a id="regions-and-zones" class="anchor" href="#regions-and-zones" aria-hidden="true"><span class="octicon octicon-link"></span></a>Regions and Zones</h1>

<p>Mesos allows agents to expose fault domain information in the form of a region and zone. A region is larger than a zone and should be thought of as containing zones. For example, a region could be a particular datacenter and the racks within that datacenter could be its zones. When this information is provided by Mesos, it is injected into each task’s environment. For example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>REGION: us-west-2
ZONE: us-west-2a
</code></pre></div></div>

<p>Services may choose to use this information to enable rack awareness. Users may then configure <a href="#placement-rules">placement rules</a> to ensure that their pods are appropriately placed within specific regions and zones, or distributed across those regions and zones. Apply placement constraints against regions and zones by referencing <code class="highlighter-rouge">@region</code> and <code class="highlighter-rouge">@zone</code> keys.  For example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[["@zone", "GROUP_BY", "2"]]
</code></pre></div></div>

<p>The placement rule above would apply the <code class="highlighter-rouge">GROUP_BY</code> operator to zones.</p>

<p>If the placement constraint for a pod defined in the service YAML references a zone as in the above example, the scheduler will create an environment variable in the environment of every task in that pod type called <code class="highlighter-rouge">PLACEMENT_REFERENCED_ZONE</code> and set it to <code class="highlighter-rouge">true</code>. Command definitions for tasks can use this to indicate to the base technology that it should operate in a region-aware fashion.</p>

<h2 id="regions-beta">
<a id="regions-beta" class="anchor" href="#regions-beta" aria-hidden="true"><span class="octicon octicon-link"></span></a>Regions (beta)</h2>

<p>The SDK allows region-aware scheduling as a beta feature.  Enable it by setting the environment variable <code class="highlighter-rouge">ALLOW_REGION_AWARENESS</code> to <code class="highlighter-rouge">true</code>.  Once enabled, placement rules can be written that reference the <code class="highlighter-rouge">@region</code> key.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[["@region", "IS", "us-west-2"]]
</code></pre></div></div>

<p>Any placement rules that do <em>not</em> reference the <code class="highlighter-rouge">@region</code> key require placement in the local region.</p>

<p>Alternatively, a stronger constraint on the region that scheduler tasks run in can be specified by setting the <code class="highlighter-rouge">ALLOW_REGION_AWARENESS</code> environment variable to true as before, and then calling the <code class="highlighter-rouge">withSingleRegionConstraint()</code> method on <code class="highlighter-rouge">SchedulerBuilder</code> when creating a scheduler object. This will cause the scheduler to look for the <code class="highlighter-rouge">SERVICE_REGION</code> variable in its environment, running all tasks in that region if specified and in the local region otherwise. To allow service users to specify an alternative region, a configuration field can be added in <code class="highlighter-rouge">config.json</code> and used to set the <code class="highlighter-rouge">SERVICE_REGION</code> environment variable in <code class="highlighter-rouge">marathon.json.mustache</code>. A service deployed in this fashion may not have its configuration updated to change the region that its tasks run in. Doing so will cause a configuration validation failure and the tasks will remain in their current state.</p>

<h1 id="tls">
<a id="tls" class="anchor" href="#tls" aria-hidden="true"><span class="octicon octicon-link"></span></a>TLS</h1>

<p><strong>This feature works only on Mesosphere DC/OS Enterprise and is not supported on Open Source DC/OS.</strong></p>

<p>The SDK provides an automated way of provisioning X.509 certificates and private keys for tasks. These TLS artifacts can be consumed by tasks to create encrypted TLS connections.</p>

<p>One or more TLS artifacts can be requested by adding the <code class="highlighter-rouge">transport-encryption</code> key to the <code class="highlighter-rouge">task</code> level YAML definition.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./service-with-tls</span><span class="nv"> </span><span class="s">--private-key=server.key</span><span class="nv"> </span><span class="s">--certificate=server.crt</span><span class="nv"> </span><span class="s">--ca-bundle=server.ca"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">0.2</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
        <span class="na">transport-encryption</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">server</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">TLS</span>
        <span class="na">ports</span><span class="pi">:</span>
            <span class="na">http</span><span class="pi">:</span>
                <span class="na">port</span><span class="pi">:</span> <span class="s">8080</span>
                <span class="na">vip</span><span class="pi">:</span>
                    <span class="na">prefix</span><span class="pi">:</span> <span class="s">server-lb</span>
                    <span class="na">port</span><span class="pi">:</span> <span class="s">80</span>
</code></pre></div></div>

<p>Every item under <code class="highlighter-rouge">transport-encryption</code> must have a unique <code class="highlighter-rouge">name</code>. The <code class="highlighter-rouge">type</code> field defines the serialization format with which the private key and certificate will be delivered into the task sandbox. Currently, there are two supported formats - <code class="highlighter-rouge">TLS</code> and <code class="highlighter-rouge">KEYSTORE</code>. Each item will result in a unique private key and the corresponding certificate.</p>

<p>The TLS artifacts within a single task will be unique for a task instance and won’t be shared across all instances of the pod task. Different tasks can request TLS artifacts with the same name, but each task will get unique private key and certificate, and they won’t get shared across different tasks.</p>

<p>In the above example, the <code class="highlighter-rouge">$MESOS_SANDBOX</code> directory would contain following files:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$MESOS_SANDBOX/
               ...
               server.key
               server.crt
               server.ca
               ...
</code></pre></div></div>

<p>Here, the file <code class="highlighter-rouge">server.crt</code> contains an end-entity certificate in the OpenSSL PEM format (if applicable, this file also includes corresponding intermediate CA certificates). The <code class="highlighter-rouge">server.key</code> contains the private key corresponding to the end-entity certificate, in the PKCS#8 PEM format. The file <code class="highlighter-rouge">server.ca</code> contains the root CA certificate in the OpenSSL PEM format.</p>

<h2 id="provisioning">
<a id="provisioning" class="anchor" href="#provisioning" aria-hidden="true"><span class="octicon octicon-link"></span></a>Provisioning</h2>

<p>TLS artifacts are provisioned by the <strong>scheduler</strong> based on the service configuration. Generated artifacts are stored as secrets in the <code class="highlighter-rouge">default</code> secrets store. The scheduler stores each artifact (private key, certificate, CA bundle, keystore, and truststore) as a separate secret under the task’s <code class="highlighter-rouge">DCOS_SPACE</code> path. This approach ensures that tasks launched by the scheduler <a href="../operations-guide/#authorization-for-secrets">will get access</a> to all necessary secrets. If the secret exists for a single artifact, then it is <strong>not</strong> overwritten and the existing value is used. Currently there is no exposed automated way of regenerating TLS artifacts. The operator can delete secrets from DC/OS secret store which will trigger generating new TLS artifacts.</p>

<p>The scheduler will generate and store TLS artifacts for both possible formats (<code class="highlighter-rouge">TLS</code>, <code class="highlighter-rouge">KEYSTORE</code>). Changing the format will not create a new private key.</p>

<p>Generated artifacts are stored as secrets with the following naming scheme:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[DCOS_SPACE]/[hash]__[pod-index-taskname]__[transport-encryption-name]__[artifact-type]
</code></pre></div></div>

<p>The <code class="highlighter-rouge">[hash]</code> represents a <code class="highlighter-rouge">SHA1</code> hash of all Subject Alternative Names that the certificate contains concatenated by <code class="highlighter-rouge">;</code> character. This hash will change every time if operator changes ports <code class="highlighter-rouge">vip</code> or <code class="highlighter-rouge">discovery</code> task configuration. See the <a href="#x509.certificate">certificate details</a> section.</p>

<p>Example of secrets that would get created based on YAML configuration above:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>hello-world/c099361a4cf931ed3a7532a6d7bf9194f35a981e__hello-0-server__server__certificate
hello-world/c099361a4cf931ed3a7532a6d7bf9194f35a981e__hello-0-server__server__private-key
hello-world/c099361a4cf931ed3a7532a6d7bf9194f35a981e__hello-0-server__server__root-ca-certificate
hello-world/c099361a4cf931ed3a7532a6d7bf9194f35a981e__hello-0-server__server__keystore
hello-world/c099361a4cf931ed3a7532a6d7bf9194f35a981e__hello-0-server__server__truststore
</code></pre></div></div>

<h3 id="lifetime-of-secrets-containing-the-tls-artifacts">
<a id="lifetime-of-secrets-containing-the-tls-artifacts" class="anchor" href="#lifetime-of-secrets-containing-the-tls-artifacts" aria-hidden="true"><span class="octicon octicon-link"></span></a>Lifetime of secrets containing the TLS artifacts</h3>

<p>When a <code class="highlighter-rouge">transport-encryption</code> item is removed from the service configuration (i.e. YAML file), it is <strong>not</strong> removed from the secret store. If the same <code class="highlighter-rouge">transport-encryption</code> configuration is added back to the service configuration, the existing TLS artifact will be used.</p>

<p>The <code class="highlighter-rouge">UninstallScheduler</code> responsible for cleaning up service installation will try to remove all TLS artifact secrets previously provisioned by the scheduler.</p>

<h3 id="task-artifacts-access">
<a id="task-artifacts-access" class="anchor" href="#task-artifacts-access" aria-hidden="true"><span class="octicon octicon-link"></span></a>Task artifacts access</h3>

<p>Each task that requests one or more TLS artifacts will get artifacts delivered to the task sandbox directory (<code class="highlighter-rouge">$MESOS_SANDBOX</code>) as a file-based secret. This feature ensures that data aren’t stored on disk and are held only in memory on the virtual filesystem. The secret appears as a normal file that can be used by an application. A task will only get TLS artifacts that are declared in the service configuration file.</p>

<h2 id="private-key-and-certificate-details">
<a id="private-key-and-certificate-details" class="anchor" href="#private-key-and-certificate-details" aria-hidden="true"><span class="octicon octicon-link"></span></a>Private key and certificate details</h2>

<p>The scheduler provisions the <em>private key</em> and <code class="highlighter-rouge">X.509</code> <em>certificate</em> and exposes them to the task in various serialization formats.</p>

<h3 id="private-key">
<a id="private-key" class="anchor" href="#private-key" aria-hidden="true"><span class="octicon octicon-link"></span></a>Private key</h3>

<p>The private key is generated by using Java <a href="https://docs.oracle.com/javase/7/docs/api/java/security/KeyPairGenerator.html"><code class="highlighter-rouge">KeyPairGenerator</code></a> initialized with <code class="highlighter-rouge">RSA</code> algorithm. The <code class="highlighter-rouge">RSA</code> key is generated with <code class="highlighter-rouge">2048</code> bit size based on <a href="https://www.keylength.com/en/4/">NIST recommendations</a>.</p>

<h3 id="x509-certificate">
<a id="x509-certificate" class="anchor" href="#x509-certificate" aria-hidden="true"><span class="octicon octicon-link"></span></a>X.509 certificate</h3>

<p>An <code class="highlighter-rouge">X.509</code> end-entity certificate corresponding to the private key is generated with the help of the <a href="https://docs.mesosphere.com/1.9/networking/tls-ssl/ca-api/">DC/OS certificate authority</a> by sending it a certificate signing request (CSR, built from the public key). The returned end-entity certificate is signed with the private key corresponding to the signing CA certificate that the DC/OS CA is configured with. That signing CA certificate can either be a root CA certificate automatically created during DC/OS cluster installation or a user-provided (custom) CA certificate.</p>

<p>A certificate has the following subject information:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>CN=[pod-index-task].[service-name]
O=Mesosphere, Inc
L=San Francisco
ST=CA
C=US
</code></pre></div></div>

<p>Additional X.509 <code class="highlighter-rouge">Subject Alternative Names</code>, based on the pod <code class="highlighter-rouge">discovery</code> and <code class="highlighter-rouge">vip</code> configurations, are encoded into the certificate. If no <code class="highlighter-rouge">discovery</code> or port exposed over VIP is configured, the single the certificate comes with a single SAN.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DNSName([pod-index-task].[service-name].autoip.dcos.thisdcos.directory)
</code></pre></div></div>

<p>Each VIP-exposed port creates in a new SAN entry:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DNSName([port-0-vip-prefix].[service-name].l4lb.thisdcos.directory)
DNSName([port-1-vip-prefix].[service-name].l4lb.thisdcos.directory)
</code></pre></div></div>

<p>Providing a custom <code class="highlighter-rouge">prefix</code> under the <code class="highlighter-rouge">discovery</code> replaces the default SAN <code class="highlighter-rouge">DNSName([pod-index-task].[service-name].autoip.dcos.thisdcos.directory)</code> with the configured name and pod index, i.e.:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>DNSName([discovery-prefix-index].[service-name].autoip.dcos.thisdcos.directory)
</code></pre></div></div>

<p>This certificate configuration allows the client to run proper TLS hostname verification when the task is accessed by one of the <a href="https://docs.mesosphere.com/1.9/networking/dns-overview/">internal DNS names</a>.</p>

<p>Each certificate is valid for <strong>10 years</strong>.</p>

<h3 id="artifacts-format">
<a id="artifacts-format" class="anchor" href="#artifacts-format" aria-hidden="true"><span class="octicon octicon-link"></span></a>Artifacts format</h3>

<p>TLS artifacts can be provided to a task in two different formats:</p>

<h4 id="pem">
<a id="pem" class="anchor" href="#pem" aria-hidden="true"><span class="octicon octicon-link"></span></a>PEM</h4>

<p>Standard <a href="https://en.wikipedia.org/wiki/Privacy-enhanced_Electronic_Mail">PEM encoded</a> certificate, private key and root CA certificate. Based on a file extension name it is possible to tell which artifact is in the file.</p>

<p>A certificate file with <strong>.crt</strong> extension contains an end-entity certificate with optional chain of certificates leading to the root CA certificate. The root CA certificate is not part of end-entity certificate file.</p>

<p>A <strong>.key</strong> file contains the PEM encoded private key.</p>

<p>A file with <strong>.crt</strong> extension contains the root CA certificate without the certificate chain.</p>

<h4 id="java-keystore">
<a id="java-keystore" class="anchor" href="#java-keystore" aria-hidden="true"><span class="octicon octicon-link"></span></a>Java Keystore</h4>

<p>The <a href="https://en.wikipedia.org/wiki/Keystore">Java Keystore (JKS)</a> is a repository of various certificates and private keys. When a private key and certificate is requested, a task will get 2 JKS format files.</p>

<p>A <strong>.keystore</strong> is a JKS file that contains a private key with an end-entity certificate and a complete certificate chain, including the root CA certificate. The certificate is stored under the alias name <strong><code class="highlighter-rouge">default</code></strong>. The keystore and key are protected by the password <strong><code class="highlighter-rouge">notsecure</code></strong>.</p>

<p>A <strong>.truststore</strong> is a JKS file that contains the DC/OS root CA certificate stored as a trust certificate. The certificate is stored under alias <strong><code class="highlighter-rouge">dcos-root</code></strong>. The keystore is protected by <strong><code class="highlighter-rouge">notsecure</code></strong> password.</p>

<p>The password <strong><code class="highlighter-rouge">notsecure</code></strong> that protects both JKS files (containing an end-entity certificate with private key and root CA certificate) has been selected because most Java tools and libraries require a password. It is not to meant to provide any additional protection. Security of both files is achieved by using DC/OS secrets store with file-based in-memory secrets. No other schedulers or tasks can access TLS artifacts provisioned by a scheduler.</p>

<h2 id="installation-requirements">
<a id="installation-requirements" class="anchor" href="#installation-requirements" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installation requirements</h2>

<p>To enable TLS support a <code class="highlighter-rouge">Mesosphere DC/OS Enterprise</code> cluster must be installed in <code class="highlighter-rouge">permissive</code> or <code class="highlighter-rouge">strict</code> security mode.</p>

<p>A scheduler must run with a <code class="highlighter-rouge">service account</code> that has permission to access:</p>

<ul>
  <li>
    <p><code class="highlighter-rouge">DC/OS CA</code> - requires <code class="highlighter-rouge">full</code> permission to <a href="https://docs.mesosphere.com/1.9/security/perms-reference/#admin-router"><code class="highlighter-rouge">dcos:adminrouter:ops:ca:rw</code></a> resource</p>
  </li>
  <li>
    <p>Secrets store - requires <code class="highlighter-rouge">full</code> permission <a href="https://docs.mesosphere.com/1.9/security/perms-reference/#secrets"><code class="highlighter-rouge">dcos:secrets:default:&lt;service-name&gt;/</code></a> and <code class="highlighter-rouge">full</code> permission on <code class="highlighter-rouge">dcos:secrets:list:default:&lt;service-name&gt;</code></p>

    <p>The secrets store authorizer supports only permissions on explicit secrets paths. Since SDK provisions many secrets for TLS artifacts it is necessary to give a <code class="highlighter-rouge">service account</code> broad <code class="highlighter-rouge">dcos:superuser</code>.</p>

    <p>This is a known limitation and it will get addressed in the future releases of the DC/OS.</p>
  </li>
</ul>

<h2 id="externalizing-transport-encryption-and-security">
<a id="externalizing-transport-encryption-and-security" class="anchor" href="#externalizing-transport-encryption-and-security" aria-hidden="true"><span class="octicon octicon-link"></span></a>Externalizing Transport Encryption and Security</h2>

<p>To use transport encryption when exposing a service outside of the cluster (e.g., putting clients on the same network as the private agents) it may be necessary to use either the DC/OS cluster’s external DNS addresses or a custom domain that fits within existing infrastructure. As such, the SDK provides a mechanism to override the domain used whenever a hostname is required (e.g., generating TLS certs)</p>

<p>By default, the SDK uses <code class="highlighter-rouge">autoip.dcos.thisdcos.directory</code> as the default top-level domain for the cluster, but as noted this may not work outside of the cluster if either multiple DC/OS clusters are being used or it is desirable to have the service accessible from an existing non DC/OS domain.</p>

<p>To set a custom top-level domain for the SDK, the scheduler environment variable <code class="highlighter-rouge">SERVICE_TLD</code> is used. In practice, this is done in the Marathon definition of the scheduler. Successfully using the custom domain requires setting up DNS forwarding.</p>

<p>Every DC/OS cluster has a unique cryptographic ID which can be used to forward DNS queries to that Cluster. External clients must have an upstream resolver configured to forward DNS queries to the DC/OS cluster of the service as described <a href="https://docs.mesosphere.com/latest/networking/DNS/mesos-dns/expose-mesos-zone/">here</a>.</p>

<p>With only forwarding configured, DNS entries within the DC/OS cluster will be resolvable at <code class="highlighter-rouge">&lt;task-domain&gt;.autoip.dcos.&lt;cryptographic-id&gt;.dcos.directory</code>. However, if you configure a DNS alias, you can use a custom domain. For example, <code class="highlighter-rouge">&lt;task-domain&gt;.cluster-1.acmeco.net</code>. If using a custom domain, you’ll also need to have the DC/OS cluster use that same upstream resolver so that the service DNS will resolve.</p>

<p>With <code class="highlighter-rouge">SERVICE_TLD</code> set to <code class="highlighter-rouge">cluster-1.acemeco.net</code> and the correct DNS configurations then the service will use <code class="highlighter-rouge">&lt;task-domain&gt;.cluster-1.acemeco.net</code> for all of its DNS hosts.</p>

<h1 id="testing">
<a id="testing" class="anchor" href="#testing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Testing</h1>

<p>The SDK provides assistance for writing both unit and integration tests.</p>

<h2 id="unit-tests">
<a id="unit-tests" class="anchor" href="#unit-tests" aria-hidden="true"><span class="octicon octicon-link"></span></a>Unit tests</h2>

<p>Unit tests enable you to make sure that changes to your dependencies do not result in breaking changes to your frameworks. The SDK uses the standard JUnit testing system. The hello-world framework provides <a href="https://github.com/mesosphere/dcos-commons/blob/master/frameworks/helloworld/src/test/java/com/mesosphere/sdk/helloworld/scheduler/ServiceTest.java">some example unit tests</a>.</p>

<p>Unit tests that follow the pattern described above will be automatically run on all pull requests, and test failures will block merges. Unit tests can be manually executed either through standard IDE test integrations or through standard gradle commands.</p>

<ul>
  <li>
    <p>All tests: <code class="highlighter-rouge">gradlew check</code></p>
  </li>
  <li>
    <p>Individual framework: <code class="highlighter-rouge">gradlew check -p frameworks/&lt;framework-name&gt;</code></p>
  </li>
</ul>

<h2 id="integration-tests">
<a id="integration-tests" class="anchor" href="#integration-tests" aria-hidden="true"><span class="octicon octicon-link"></span></a>Integration tests</h2>

<p>Within the context of the SDK, integration tests validate expected service behavior in a DC/OS cluster. The SDK provides utilities in its <a href="https://github.com/mesosphere/dcos-commons/tree/master/testing">testing/</a> directory centered around writing these tests. These make it easy to perform service operations such as install, uninstall, configuration update, software upgrade, rollback, and pod restart. As with unit tests, these tests are run against every pull request and failures blocks merges. The reference hello-world framework provides many <a href="https://github.com/mesosphere/dcos-commons/blob/master/frameworks/helloworld/tests/test_sanity.py">example integration tests</a> which are used to validate SDK behavior.</p>

<p>You can run integration tests manually using <code class="highlighter-rouge">py.test</code>.  The
integration tests assume you have a running DC/OS cluster, and have
installed the
<a href="https://docs.mesosphere.com/latest/cli/install/">DC/OS CLI</a>.</p>

<p>Here’s an example of running the tests for the <code class="highlighter-rouge">helloworld</code> framework:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>tools/venvutil.py create venv
<span class="nv">$ </span><span class="nb">source </span>venv/bin/activate
<span class="nv">$ </span>py.test frameworks/helloworld/
</code></pre></div></div>

<h1 id="advanced-dcos-service-definition">
<a id="advanced-dcos-service-definition" class="anchor" href="#advanced-dcos-service-definition" aria-hidden="true"><span class="octicon octicon-link"></span></a>Advanced DC/OS Service Definition</h1>

<h2 id="servicespec-yaml">
<a id="servicespec-yaml" class="anchor" href="#servicespec-yaml" aria-hidden="true"><span class="octicon octicon-link"></span></a><code class="highlighter-rouge">ServiceSpec</code> (YAML)</h2>

<p>The most basic set of features present in the YAML representation of the <code class="highlighter-rouge">ServiceSpec</code> are <a href="#service-spec">presented above</a>. The remaining features are introduced below.</p>

<h3 id="pods">
<a id="pods" class="anchor" href="#pods" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pods</h3>

<p>You may specify the number of pod instances to be run for every pod. As a safety measure, after initial install, users can increase but not decrease this value. If you wish to allow scale-in of your pods, you must specify <code class="highlighter-rouge">allow-decommission: true</code> for each applicable pod:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">3</span>
    <span class="na">allow-decommission</span><span class="pi">:</span> <span class="no">true</span>
    <span class="s">...</span>
</code></pre></div></div>

<p>You should only enable this option if it is safe for the pod’s tasks be destroyed without needing to perform additional rebalancing or drain operations beforehand.</p>

<p>Pods removed from a service specification entirely will be decommissioned.  All instances of undefined pods will have their tasks killed and all their resources released back to the cluster.  <strong>Note:</strong> If you instead wish to kill tasks <em>without</em> releasing their resources back to the cluster, you may do this using a <a href="#custom-deployment-plan">custom deployment plan</a>.</p>

<p>For example, updating a <code class="highlighter-rouge">ServiceSpec</code> from:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">allow-decommission</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">1.0</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
  <span class="na">world</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">world"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">1.0</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
</code></pre></div></div>

<p>to:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">world</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">world"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">1.0</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
</code></pre></div></div>

<p>would result in all <code class="highlighter-rouge">hello-&lt;index&gt;-server</code> tasks being killed and their resources unreserved. <strong>Note:</strong> In order for the pod to be removed, it <em>must</em> have specified <code class="highlighter-rouge">allow-decommission: true</code> before the removal. If you wish to decommission a pod which doesn’t currently allow decommissioning, two configuration updates must be performed: one to add <code class="highlighter-rouge">allow-decommission: true</code> to the pod specification and another to remove the pod specification.</p>

<h3 id="non-essential-tasks">
<a id="non-essential-tasks" class="anchor" href="#non-essential-tasks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Non-essential tasks</h3>

<p>When multiple <code class="highlighter-rouge">goal: RUNNING</code> tasks are defined in a single pod and one of those tasks has exited, the default behavior is to relaunch <em>all</em> of the <code class="highlighter-rouge">goal: RUNNING</code> tasks in the pod. To change this behavior, tasks may be marked “non-essential” by specifying <code class="highlighter-rouge">essential: false</code> in their <code class="highlighter-rouge">TaskSpec</code>. When a non-essential task exits, it will be automatically relaunched without disturbing other tasks in the pod. For an example, see the following <code class="highlighter-rouge">ServiceSpec</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">allow-decommission</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">1.0</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
      <span class="na">monitor</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">monitor"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">1.0</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
        <span class="na">essential</span><span class="pi">:</span> <span class="no">false</span>
</code></pre></div></div>

<p>In this example, the <code class="highlighter-rouge">monitor</code> task is marked as non-essential, while the <code class="highlighter-rouge">server</code> task continues to be essential. If the <code class="highlighter-rouge">monitor</code> task exits, it will be automatically relaunched without disturbing the <code class="highlighter-rouge">server</code> task. However if the <code class="highlighter-rouge">server</code> task exits, then both the <code class="highlighter-rouge">server</code> task and the <code class="highlighter-rouge">monitor</code> task will both be relaunched.</p>

<p>This option is only relevant for pods containing multiple <code class="highlighter-rouge">goal: RUNNING</code> tasks.</p>

<h3 id="containers">
<a id="containers" class="anchor" href="#containers" aria-hidden="true"><span class="octicon octicon-link"></span></a>Containers</h3>

<p>Each pod runs inside a single container. The <code class="highlighter-rouge">ServiceSpec</code> specifies the following:</p>
<ul>
  <li>We can specify the <code class="highlighter-rouge">image</code> that we want to use, for example, a Docker image. The image is run in the Mesos <a href="https://docs.mesosphere.com/latest/deploying-services/containerizers/ucr/">Universal Container Runtime</a>.</li>
  <li>The <code class="highlighter-rouge">networks</code> field specifies the virtual networks to join. For a container to have its own IP address, it must join a virtual network. One example of a supported virtual network is the <code class="highlighter-rouge">dcos</code> overlay network.</li>
  <li>The <code class="highlighter-rouge">rlimits</code> field allows you to set POSIX resource limits for every task that runs inside the container.</li>
</ul>

<p>The example <code class="highlighter-rouge">ServiceSpec</code> below specifies:</p>
<ul>
  <li>The <code class="highlighter-rouge">ubuntu</code> container image.</li>
  <li>The soft limit for number of open file descriptors for any task in the <code class="highlighter-rouge">hello</code> pod as 1024, and the hard limit to 2048.</li>
  <li>That the pod should join the <code class="highlighter-rouge">dcos</code> virtual network.</li>
</ul>

<p>In the example below, we’re specifying that we want to run the <code class="highlighter-rouge">ubuntu</code> image, the soft limit for number of open file descriptors for any task in the “hello” pod is set to 1024, the hard limit to 2048 and we’re specifying that the pod joins the <code class="highlighter-rouge">dcos</code> virtual network:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">image</span><span class="pi">:</span> <span class="s">ubuntu</span>
    <span class="na">networks</span><span class="pi">:</span>
      <span class="na">dcos</span><span class="pi">:</span>
    <span class="na">rlimits</span><span class="pi">:</span>
      <span class="na">RLIMIT_NOFILE</span><span class="pi">:</span>
        <span class="na">soft</span><span class="pi">:</span> <span class="s">1024</span>
        <span class="na">hard</span><span class="pi">:</span> <span class="s">2048</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">1.0</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
</code></pre></div></div>

<p>For a full list of which rlimits are supported, refer to <a href="https://github.com/apache/mesos/blob/master/docs/isolators/posix-rlimits.md">the Mesos documentation on rlimits</a>.</p>

<p><strong>Virtual networks</strong>
The SDK supports having pods join virtual networks (including the <code class="highlighter-rouge">dcos</code> overlay network). For an in-depth explanation of how virtual networks work on DC/OS see the <a href="https://docs.mesosphere.com/latest/networking/virtual-networks/#virtual-network-service-dns">documentation</a>. When a pod joins a virtual network it gets its own IP address and has access to its own array of ports. Therefore when a pod specifies that it is joining <code class="highlighter-rouge">dcos</code> we ignore the <code class="highlighter-rouge">ports</code> resource requirements, because the pod will not consume the ports on the host machine. The DNS for pods on this virtual network is <code class="highlighter-rouge">&lt;task_name&gt;.&lt;framework_name&gt;.autoip.dcos.thisdcos.directory</code>. Note that this DNS will also work for pods on the host network. <strong>Because the <code class="highlighter-rouge">ports</code> resources are not used when a pod is on the virtual network, we do not allow a pod to be moved from a virtual network to the host network or vice-versa</strong>. This is to prevent potential starvation of the task when the host with the reserved resources for the task does not have the available ports required to launch the task.</p>

<h3 id="placement-rules">
<a id="placement-rules" class="anchor" href="#placement-rules" aria-hidden="true"><span class="octicon octicon-link"></span></a>Placement Rules</h3>

<p>Pods specifications may be configured with placement rules which describe where and how those pods may be deployed in the cluster. This setting supports all <a href="https://mesosphere.github.io/marathon/docs/constraints.html">Marathon-style placement operators</a>, using the following format: <code class="highlighter-rouge">["field", "operator"[, "parameter"]]</code>. If you require placement logic that isn’t offered by the default Marathon-style placement operators, you should consider using <a href="#placement-rules">PlacementRules in Java</a>.</p>

<p>We recommend exposing placement constraints as templated out configuration settings, so that they may be easily customized by end-users. For example, your YAML specification may contain the following:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">3</span>
    <span class="na">placement</span><span class="pi">:</span> <span class="s1">'</span><span class="s">{{{HELLO_PLACEMENT}}}'</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">1.0</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
</code></pre></div></div>

<p>In this example your configuration would expose a <code class="highlighter-rouge">HELLO_PLACEMENT</code> configuration setting with some default value. You may then provide a default value for that setting, such as <code class="highlighter-rouge">[["hostname", "UNIQUE"]]</code> to ensure that no two hello instances are on the same agent at a time, or <code class="highlighter-rouge">[["rack_id", "LIKE", "rack-foo-.*"]]</code> to ensure that hello instances are only placed on agents with a <code class="highlighter-rouge">rack_id</code> that starts with <code class="highlighter-rouge">"rack-foo-"</code>. Multiple placement rules may be ANDed together by separating them with a comma, e.g. <code class="highlighter-rouge">[["hostname", "UNIQUE"], ["rack_id", "LIKE", "rack-foo-.*"]]</code>.</p>

<h3 id="resource-sets">
<a id="resource-sets" class="anchor" href="#resource-sets" aria-hidden="true"><span class="octicon octicon-link"></span></a>Resource Sets</h3>

<p>A Mesos task is always a process that consumes some resources. In the example below, the server task is a command that prints “hello” to a file while consuming 1.0 CPUs, 256 MB of memory, and 50 MB of disk space for its volume.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">hello-container-path/output</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">1.0</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
        <span class="na">volume</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-container-path"</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">ROOT</span>
          <span class="na">size</span><span class="pi">:</span> <span class="s">50</span>
</code></pre></div></div>

<p>An equivalent way to define the same task is as follows:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">resource-sets</span><span class="pi">:</span>
      <span class="na">hello-resources</span><span class="pi">:</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">1.0</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
        <span class="na">volume</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-container-path"</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">ROOT</span>
          <span class="na">size</span><span class="pi">:</span> <span class="s">50</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">hello-container-path/output</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span>
        <span class="na">resource-set</span><span class="pi">:</span> <span class="s">hello-resources/</span>
</code></pre></div></div>

<p>In this case, the resources are declared separately from the server task in a resource set named <code class="highlighter-rouge">hello-resources</code>. They are referenced by a <code class="highlighter-rouge">resource-set</code> element in the task definition. A task continues to be defined as the combination of a process to run and resources to consume. This alternate formulation provides you with increased flexibility: you can now define multiple processes that can consume the same resources.</p>

<p><strong>Note:</strong> Resource sets are reserved at scheduler startup. <a href="#custom-auxiliary-plans">Custom auxiliary plans</a> that run tasks referencing resource sets won’t require additional resources than what the scheduler already reserved.</p>

<p>Pods can also define volumes at the pod level, allowing volumes to be shared between every task in a pod. Although volumes defined on individual tasks are currently visible between tasks in a pod, this will change with the introduction of pods based on <a href="https://github.com/apache/mesos/blob/master/docs/nested-container-and-task-group.md">Mesos Task Groups</a>. Once this change is made, pods will need to define volumes at the pod level if they are intended to be shared across tasks, as in the following example:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">volume</span><span class="pi">:</span>
      <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">shared-container-path"</span>
      <span class="na">type</span><span class="pi">:</span> <span class="s">ROOT</span>
      <span class="na">size</span><span class="pi">:</span> <span class="s">50</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">shared-container-path/output</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">1.0</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
</code></pre></div></div>

<p><strong>Important:</strong> At any given point in time, only a single process may be consuming a given set of resources. <strong>Resources may never be shared simultaneously by multiple tasks</strong>.  Any attempt to launch a task consuming an already consumed resource-set will result in the killing of the task which is currently running and the launch of the new task.</p>

<p>This alternative formulation of tasks is useful when several tasks should be sequenced in the same container and have a cumulative effect on data in a volume. For example, if you want to initialize something before running the long running server task, you could write the following:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">resource-sets</span><span class="pi">:</span>
      <span class="na">hello-resources</span><span class="pi">:</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">1.0</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
        <span class="na">volume</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-container-path"</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">ROOT</span>
          <span class="na">size</span><span class="pi">:</span> <span class="s">50</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">initialize</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">ONCE</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">initialize</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">hello-container-path/output"</span>
        <span class="na">resource-set</span><span class="pi">:</span> <span class="s">hello-resources</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">hello-container-path/output</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span>
        <span class="na">resource-set</span><span class="pi">:</span> <span class="s">hello-resources</span>
</code></pre></div></div>

<p>Both tasks now refer to the same resource set. However, since they cannot consume this resource simultaneously we must impose an ordering. We want to run the initialize task, allow it to finish, and then start the long running server task, which produces the following output in the hello-container-path/output file:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>initialize
hello
</code></pre></div></div>

<p>Provide an ordering by specifying a custom deployment plan. The final YAML file would be:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">resource-sets</span><span class="pi">:</span>
      <span class="na">hello-resources</span><span class="pi">:</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">1.0</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
        <span class="na">volume</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-container-path"</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">ROOT</span>
          <span class="na">size</span><span class="pi">:</span> <span class="s">50</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">initialize</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">ONCE</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">initialize</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">hello-container-path/output"</span>
        <span class="na">resource-set</span><span class="pi">:</span> <span class="s">hello-resources</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">hello-container-path/output</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span>
        <span class="na">resource-set</span><span class="pi">:</span> <span class="s">hello-resources</span>
<span class="na">plans</span><span class="pi">:</span>
  <span class="na">deploy</span><span class="pi">:</span>
    <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
    <span class="na">phases</span><span class="pi">:</span>
      <span class="na">hello-deploy</span><span class="pi">:</span>
        <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
        <span class="na">pod</span><span class="pi">:</span> <span class="s">hello</span>
        <span class="na">steps</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">default</span><span class="pi">:</span> <span class="pi">[[</span><span class="nv">initialize</span><span class="pi">],</span> <span class="pi">[</span><span class="nv">server</span><span class="pi">]]</span>
</code></pre></div></div>

<p>The plan defined above, the instance of the hello pod with index 0 should first have the initialize task run, followed by the server task. Because they refer to the same resource set and their commands print to the same file in the same volume, the sequencing of tasks has a cumulative effect on the container context. For a fully featured practical example of this pattern, <a href="https://github.com/mesosphere/dcos-commons/blob/master/frameworks/hdfs/src/main/dist/svc.yml">see the HDFS service here</a>.</p>

<h3 id="sidecar-plans">
<a id="sidecar-plans" class="anchor" href="#sidecar-plans" aria-hidden="true"><span class="octicon octicon-link"></span></a>Sidecar Plans</h3>

<p>You can include arbitrary additional plans beyond the deploy plan.  These may be executed at runtime to perform, for example, maintenance operations like backup.  Below we have an example describing how to declare a sidecar plan.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">resource-sets</span><span class="pi">:</span>
      <span class="na">hello-resources</span><span class="pi">:</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">1</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
      <span class="na">sidecar-resources</span><span class="pi">:</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">0.1</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">output</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">$SLEEP_DURATION"</span>
        <span class="na">resource-set</span><span class="pi">:</span> <span class="s">hello-resources</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="na">SLEEP_DURATION</span><span class="pi">:</span> <span class="s">1000</span>
      <span class="na">sidecar</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">ONCE</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">$PLAN_PARAMETER1</span><span class="nv"> </span><span class="s">$PLAN_PARAMETER2</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">output"</span>
        <span class="na">resource-set</span><span class="pi">:</span> <span class="s">sidecar-resources</span>
<span class="na">plans</span><span class="pi">:</span>
  <span class="na">sidecar-example</span><span class="pi">:</span>
    <span class="na">strategy</span><span class="pi">:</span> <span class="s">serial</span>
    <span class="na">phases</span><span class="pi">:</span>
      <span class="na">sidecar-deploy</span><span class="pi">:</span>
        <span class="na">strategy</span><span class="pi">:</span> <span class="s">parallel</span>
        <span class="na">pod</span><span class="pi">:</span> <span class="s">hello</span>
        <span class="na">steps</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">default</span><span class="pi">:</span> <span class="pi">[[</span><span class="nv">sidecar</span><span class="pi">]]</span>
</code></pre></div></div>

<p>The command definition for the sidecar task includes environment variables, <code class="highlighter-rouge">PLAN_PARAMETER1</code> and <code class="highlighter-rouge">PLAN_PARAMETER2</code>, that are not defined elsewhere in the service definition. You can supply these parameters when the plan is initiated.  The parameters will be propagated to the environment of every task launched by the plan.</p>

<p>To initiate the plan, execute an HTTP POST request against the <code class="highlighter-rouge">/v1/plans/sidecar-example/start</code> endpoint with the header <code class="highlighter-rouge">Content-Type: application/json</code> set and a JSON body consisting of environment variable name/value pairs. For example:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>curl <span class="nt">-k</span> <span class="nt">-X</span> POST <span class="nt">-H</span> <span class="s2">"Authorization: token=</span><span class="nv">$AUTH_TOKEN</span><span class="s2">"</span> <span class="nt">-H</span> <span class="s2">"Content-Type: application/json"</span> <span class="nt">--data</span> <span class="s1">'{"PLAN_PARAMETER1": "sidecar", "PLAN_PARAMETER2": "plan"}'</span> http://&lt;dcos_url&gt;/service/hello-world/v1/plans/sidecar-example/start
</code></pre></div></div>

<p>You can also use the DC/OS CLI:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>dcos <span class="nv">$FRAMEWORK_NAME</span> plan start sidecar-example <span class="nt">-p</span> <span class="nv">PLAN_PARAMETER1</span><span class="o">=</span>sidecar <span class="nt">-p</span> <span class="nv">PLAN_PARAMETER2</span><span class="o">=</span>plan
</code></pre></div></div>

<p>When no parameters are specified, the body of the POST request must be an empty JSON object (<code class="highlighter-rouge">{}</code>). Supply default values with standard Bash syntax. In the above case, you can declare the default value of <code class="highlighter-rouge">PLAN_PARAMETER1</code> to be <code class="highlighter-rouge">sidecar</code> by changing the task’s command string to <code class="highlighter-rouge">echo ${PLAN_PARAMETER1:-sidecar} &gt;&gt; output</code>.</p>

<p>Monitor sidecar plan progress like any other plan: by issuing GET requests against the <code class="highlighter-rouge">/v1/plans/sidecar-example</code> endpoint.</p>

<p>Because the sidecar task is defined inside the hello pod, it will run inside the hello pod when the sidecar-example plan is started.  This gives it access to all the resources in the hello pod, including any persistent volumes that may be present.  In this way, a backup plan could be constructed and executed on demand.</p>

<h3 id="uris">
<a id="uris" class="anchor" href="#uris" aria-hidden="true"><span class="octicon octicon-link"></span></a>URIs</h3>

<p>You can include an arbitrary list of URIs to download before launching a task or before launching a pod. The Mesos fetcher automatically extracts and caches the URIs. To attach URIs to the context of a task, modify the YAML as below:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">1.0</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
        <span class="na">uris</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">https://foo.bar.com/package.tar.gz</span>
          <span class="pi">-</span> <span class="s">https://foo.bar.com/bundle.tar.gz</span>
</code></pre></div></div>

<p>To add URIs to a pod, modify the YAML as below:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">uris</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">https://foo.bar.com/package.tar.gz</span>
      <span class="pi">-</span> <span class="s">https://foo.bar.com/bundle.tar.gz</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">1.0</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
</code></pre></div></div>

<p>URIs included in a pod are accessible to all its tasks.</p>

<h3 id="configuration-templates">
<a id="configuration-templates" class="anchor" href="#configuration-templates" aria-hidden="true"><span class="octicon octicon-link"></span></a>Configuration Templates</h3>

<p>It is common for a service to require configuration files to be present in the context of a task.  The SDK provides a method for defining and placing task-specific configuration files. A configuration file is template that can be dynamically rendered by environment variables. Add a configuration file to a task in the following way:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">0.1</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
        <span class="na">configs</span><span class="pi">:</span>
          <span class="s">config.xml</span><span class="pi">:</span>
            <span class="na">template</span><span class="pi">:</span> <span class="s">config.xml.mustache</span>
            <span class="na">dest</span><span class="pi">:</span> <span class="s">etc/config.xml</span>
</code></pre></div></div>

<p>The template content may be templated using the <a href="https://mustache.github.io/mustache.5.html">mustache format</a>. Any templated parameters in the file may be automatically populated with environment variables <em>from within the task</em>, by including the <code class="highlighter-rouge">bootstrap</code> utility in your tasks. See <a href="#task-bootstrap">Bootstrap Tool</a> for more information. at the beginning of the task.</p>

<p>For example, say you had a container with the following environment variables:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">PORT_FOO</span><span class="o">=</span>1984
<span class="nv">FRAMEWORK_NAME</span><span class="o">=</span>mysvc
</code></pre></div></div>

<p>And a <code class="highlighter-rouge">config.xml.mustache</code> template like this:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;config&gt;</span>
  <span class="nt">&lt;port&gt;</span>{{PORT_FOO}}<span class="nt">&lt;/port&gt;</span>
  <span class="nt">&lt;service&gt;</span>{{FRAMEWORK_NAME}}<span class="nt">&lt;/service&gt;</span>
  <span class="c">&lt;!-- ... --&gt;</span>
<span class="nt">&lt;/config&gt;</span>
</code></pre></div></div>

<p>When the <code class="highlighter-rouge">bootstrap</code> helper is run, it would automatically create a populated version of that file in <code class="highlighter-rouge">etc/config.xml</code>:</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;config&gt;</span>
  <span class="nt">&lt;port&gt;</span>1984<span class="nt">&lt;/port&gt;</span>
  <span class="nt">&lt;game&gt;</span>mysvc<span class="nt">&lt;/game&gt;</span>
  <span class="c">&lt;!-- ... --&gt;</span>
<span class="nt">&lt;/config&gt;</span>
</code></pre></div></div>

<p>To be clear, the config templating provided by the <code class="highlighter-rouge">bootstrap</code> tool may be applied to <em>any text format</em>, not just XML as in this example. This makes it a powerful tool for handling any config files your service may need. Read more about setting this up in the <a href="#bootstrap">Bootstrap Tool</a> section.</p>

<h3 id="task-environment">
<a id="task-environment" class="anchor" href="#task-environment" aria-hidden="true"><span class="octicon octicon-link"></span></a>Task Environment</h3>

<p>Task configuration is generally exposed using environment variables. A number of environment variables that describe the task and/or cluster environment are provided automatically, while the developer can manually specify others.</p>

<h4 id="included-values">
<a id="included-values" class="anchor" href="#included-values" aria-hidden="true"><span class="octicon octicon-link"></span></a>Included Values</h4>

<p>The following environment values are automatically injected into all tasks as a convenience. These typically provide some additional context about the container.</p>

<ul>
  <li><code class="highlighter-rouge">TASK_NAME=hello-3-server</code></li>
</ul>

<p>The name of the task, such as <code class="highlighter-rouge">hello-3-server</code>.</p>

<ul>
  <li><code class="highlighter-rouge">&lt;task-name&gt;=true</code></li>
</ul>

<p>The name of the task as the environment variable, with a value of <code class="highlighter-rouge">true</code>. Useful in mustache templating.</p>

<ul>
  <li><code class="highlighter-rouge">POD_INSTANCE_INDEX=3</code></li>
</ul>

<p>The index of the pod instance, starting at zero. For example a task named <code class="highlighter-rouge">hello-3-server</code> would have a <code class="highlighter-rouge">POD_INSTANCE_INDEX</code> of <code class="highlighter-rouge">3</code>.</p>

<ul>
  <li>
<code class="highlighter-rouge">REGION=us-west-2</code> / <code class="highlighter-rouge">ZONE=us-west-2a</code>
</li>
</ul>

<p>The Region and Zone of the machine running the task. For more information about these values, see <a href="#regions-and-zones">Regions and Zones</a>.</p>

<ul>
  <li><code class="highlighter-rouge">FRAMEWORK_NAME=/folder/servicename</code></li>
</ul>

<p>The name of the service as configured by the user. May contain slashes if the service is in a folder.</p>

<ul>
  <li><code class="highlighter-rouge">FRAMEWORK_HOST=folderservicename.autoip.thisdcos.directory</code></li>
</ul>

<p>The TLD for accessing tasks within the service. To address a given task, one could construct a hostname as <code class="highlighter-rouge">&lt;taskname&gt;.FRAMEWORK_HOST</code>. This varies according to the service name as configured by the user.</p>

<ul>
  <li><code class="highlighter-rouge">FRAMEWORK_VIP_HOST=folderservicename.l4lb.thisdcos.directory</code></li>
</ul>

<p>The TLD for VIPs advertised by the service. To address a given VIP, one could construct a hostname as <code class="highlighter-rouge">&lt;vipname&gt;.FRAMEWORK_VIP_HOST</code>. This varies according to the service name as configured by the user.</p>

<ul>
  <li><code class="highlighter-rouge">SCHEDULER_API_HOSTNAME=api.folderservicename.marathon.l4lb.thisdcos.directory</code></li>
</ul>

<p>The hostname where the Scheduler can be reached. Useful when tasks need to make API calls to a custom endpoint that’s being run by the Scheduler.</p>

<h4 id="specifying-values">
<a id="specifying-values" class="anchor" href="#specifying-values" aria-hidden="true"><span class="octicon octicon-link"></span></a>Specifying Values</h4>

<p>You can define the environment of a task in a few different ways. In the YML <code class="highlighter-rouge">ServiceSpec</code>, it can be defined in the following way.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">0.1</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
        <span class="na">env</span><span class="pi">:</span>
          <span class="na">FOO</span><span class="pi">:</span> <span class="s">bar</span>
          <span class="na">BAZ</span><span class="pi">:</span> <span class="pi">{{</span><span class="nv">BAZ</span><span class="pi">}}</span>
</code></pre></div></div>

<p>As in any other case, environment variables may be templated values. Schedulers written using the SDK also detect particular formats of environment. To inject a common set of environment variables into the contexts of all tasks, you can add environment variables to the scheduler’s context in the form below:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TASKCFG_ALL_&lt;KEY&gt;: &lt;VALUE&gt;
</code></pre></div></div>

<p>For example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TASKCFG_ALL_FOO: BAR → FOO: BAR
</code></pre></div></div>

<p>To inject environment variables into the contexts of all instances of a particular pod type, define environment variables of the form below to the scheduler’s context.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TASKCFG_&lt;POD-NAME&gt;_&lt;KEY&gt;: &lt;VALUE&gt;
</code></pre></div></div>

<p>For example:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TASKCFG_HELLO_BAZ: BAZ → BAZ: BAZ
</code></pre></div></div>

<h3 id="task-bootstrap">
<a id="task-bootstrap" class="anchor" href="#task-bootstrap" aria-hidden="true"><span class="octicon octicon-link"></span></a>Task Bootstrap</h3>

<p>The <code class="highlighter-rouge">cmd</code> in each task defines what’s run for the lifetime of that task. A common problem when defining tasks is providing some sort of initial configuration, waiting for hosts to resolve, and other up-front work.</p>

<p>The <code class="highlighter-rouge">bootstrap</code> utility executable is available for running at the start of your tasks to perform these common task operations, including:</p>

<ul>
  <li>Logging <code class="highlighter-rouge">env</code> (useful for debugging)</li>
  <li>Rendering any <code class="highlighter-rouge">configs</code> provided in the task definition and writing the result to the configured <code class="highlighter-rouge">dest</code>s.</li>
  <li>Waiting for the task’s own hostname to be resolvable, or optionally wait for other custom hostnames to be resolvable, before exiting</li>
</ul>

<p>These operations may be enabled, disabled, and customized via <code class="highlighter-rouge">bootstrap</code>s commandline arguments in your <code class="highlighter-rouge">cmd</code>. See the <a href="https://github.com/mesosphere/dcos-commons/blob/master/sdk/bootstrap/main.go">source code</a> for more details on what specific options are available.</p>

<p>Including <code class="highlighter-rouge">bootstrap</code> in your tasks is a manual but straightforward operation. First, you should to add it to the package definition (<code class="highlighter-rouge">resources.json</code> and <code class="highlighter-rouge">marathon.json.mustache</code>), then include it in the service definition (<code class="highlighter-rouge">svc.yml</code>):</p>

<p><code class="highlighter-rouge">resources.json</code>:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"assets"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"uris"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="s2">"..."</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="p">,</span><span class="w">
      </span><span class="s2">"bootstrap-zip"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{artifact-dir}}/bootstrap.zip"</span><span class="p">,</span><span class="w">
      </span><span class="s2">"..."</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><code class="highlighter-rouge">marathon.json.mustache</code>:</p>

<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="s2">"id"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{service.name}}"</span><span class="p">,</span><span class="w">
  </span><span class="s2">"cpus"</span><span class="p">:</span><span class="w"> </span><span class="mf">1.0</span><span class="p">,</span><span class="w">
  </span><span class="s2">"mem"</span><span class="p">:</span><span class="w"> </span><span class="mi">2048</span><span class="p">,</span><span class="w">
  </span><span class="s2">"env"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="s2">"BOOTSTRAP_URI"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{resource.assets.uris.bootstrap-zip}}"</span><span class="p">,</span><span class="w">
    </span><span class="s2">"..."</span><span class="p">:</span><span class="w"> </span><span class="s2">"..."</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>

<p><code class="highlighter-rouge">svc.yml</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">uris</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="pi">{{</span><span class="nv">BOOTSTRAP_URI</span><span class="pi">}}</span> <span class="c1"># fetch/unpack bootstrap.zip into this pod</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./bootstrap</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span> <span class="c1"># run 'bootstrap' before 'hello'</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">0.1</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
        <span class="na">configs</span><span class="pi">:</span>
          <span class="s">config.xml</span><span class="pi">:</span>
            <span class="na">template</span><span class="pi">:</span> <span class="s2">"</span><span class="s">config.xml.mustache"</span>
            <span class="na">dest</span><span class="pi">:</span> <span class="s">etc/config.xml</span>
</code></pre></div></div>

<p>Now the <code class="highlighter-rouge">bootstrap</code> executable will automatically be run at the start of <code class="highlighter-rouge">hello</code> tasks. By default it will first print the <code class="highlighter-rouge">env</code>, then will handle rendering the <code class="highlighter-rouge">config.xml.mustache</code> template to <code class="highlighter-rouge">etc/config.xml</code>, then wait for the hello task’s hostname to be locally resolvable.</p>

<h3 id="health-checks">
<a id="health-checks" class="anchor" href="#health-checks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Health Checks</h3>

<p>If a task is unhealthy, the scheduler will kill and restart it.  You may define a health check for a task by adding a <code class="highlighter-rouge">health-check</code> parameter to its <code class="highlighter-rouge">TaskSpec</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">0.1</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
        <span class="na">health-check</span><span class="pi">:</span>
          <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./check-up"</span>
          <span class="na">interval</span><span class="pi">:</span> <span class="s">5</span>
          <span class="na">grace-period</span><span class="pi">:</span> <span class="s">30</span>
          <span class="na">max-consecutive-failures</span><span class="pi">:</span> <span class="s">3</span>
          <span class="na">delay</span><span class="pi">:</span> <span class="s">0</span>
          <span class="na">timeout</span><span class="pi">:</span> <span class="s">10</span>
</code></pre></div></div>

<p>The interval, grace-period, delay, and timeout elements are denominated in seconds. If the maximum consecutive number of failures is exceeded, the task will be killed.</p>

<h3 id="readiness-checks">
<a id="readiness-checks" class="anchor" href="#readiness-checks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Readiness Checks</h3>

<p>Use a readiness check when a task must perform some initialization before subsequent steps run.  By default, a <a href="#plans">step</a> will be <code class="highlighter-rouge">COMPLETE</code> when its task reaches its goal state (<code class="highlighter-rouge">RUNNING</code> or <code class="highlighter-rouge">COMPLETED</code>), but if the task has a <strong>readiness check</strong>, its step won’t be <code class="highlighter-rouge">COMPLETE</code> until its readiness check passes.  You may define a readiness check for a task by adding a <code class="highlighter-rouge">readiness-check</code> parameter to its <code class="highlighter-rouge">TaskSpec</code>:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">1</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">1000"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">0.1</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
        <span class="na">readiness-check</span><span class="pi">:</span>
          <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">./readiness-check"</span>
          <span class="na">interval</span><span class="pi">:</span> <span class="s">5</span>
          <span class="na">delay</span><span class="pi">:</span> <span class="s">0</span>
          <span class="na">timeout</span><span class="pi">:</span> <span class="s">10</span>
</code></pre></div></div>

<p>The interval, delay, and timeout elements are denominated in seconds.</p>

<h3 id="volumes">
<a id="volumes" class="anchor" href="#volumes" aria-hidden="true"><span class="octicon octicon-link"></span></a>Volumes</h3>

<p>Persistent volumes allow data to be stored on disks and survive.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">3</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">hello-container-path/output</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">$SLEEP_DURATION"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">1.0</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
        <span class="na">volume</span><span class="pi">:</span>
          <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-container-path"</span>
          <span class="na">type</span><span class="pi">:</span> <span class="s">ROOT</span>
          <span class="na">size</span><span class="pi">:</span> <span class="s">5000</span>
</code></pre></div></div>

<p>The path is relative to the sandbox path if not preceded by a leading “/”. The sandbox path is always available in the environment variable MESOS_SANDBOX.  The different between ROOT and MOUNT volumes is <a href="https://mesos.apache.org/documentation/latest/multiple-disk/">documented here</a>. The PATH type is not currently supported.</p>

<p>Multiple volumes per pod or task can also be defined in a service YAML file.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">hello-world"</span>
<span class="na">pods</span><span class="pi">:</span>
  <span class="na">hello</span><span class="pi">:</span>
    <span class="na">count</span><span class="pi">:</span> <span class="s">3</span>
    <span class="na">tasks</span><span class="pi">:</span>
      <span class="na">server</span><span class="pi">:</span>
        <span class="na">goal</span><span class="pi">:</span> <span class="s">RUNNING</span>
        <span class="na">cmd</span><span class="pi">:</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">hello</span><span class="nv"> </span><span class="s">&gt;&gt;</span><span class="nv"> </span><span class="s">hello-container-path/output</span><span class="nv"> </span><span class="s">&amp;&amp;</span><span class="nv"> </span><span class="s">sleep</span><span class="nv"> </span><span class="s">$SLEEP_DURATION"</span>
        <span class="na">cpus</span><span class="pi">:</span> <span class="s">1.0</span>
        <span class="na">memory</span><span class="pi">:</span> <span class="s">256</span>
        <span class="na">volumes</span><span class="pi">:</span>
          <span class="na">volume1</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">volume1"</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">ROOT</span>
            <span class="na">size</span><span class="pi">:</span> <span class="s">5000</span>
          <span class="na">volume2</span><span class="pi">:</span>
            <span class="na">path</span><span class="pi">:</span> <span class="s2">"</span><span class="s">volume2"</span>
            <span class="na">type</span><span class="pi">:</span> <span class="s">ROOT</span>
            <span class="na">size</span><span class="pi">:</span> <span class="s">2500</span>
</code></pre></div></div>

<p><a name="proxy-fallback"></a></p>
<h3 id="proxy-fallback">
<a id="proxy-fallback" class="anchor" href="#proxy-fallback" aria-hidden="true"><span class="octicon octicon-link"></span></a>Proxy Fallback</h3>

<p>Applications may not work properly behind adminrouter. In that case, one may use <a href="https://gist.github.com/nlsun/877411115f7e3b885b5e9daa8821722f">Repoxy</a>.</p>

<!--  disable mustache templating in this file: retain templated examples as-is -->

</div>
</div>
</body>

</html>
